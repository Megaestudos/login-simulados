<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Desbloquear Premium</title>
  <style>
    body{font-family:system-ui,Arial;margin:0;min-height:100vh;display:grid;place-items:center;background:#0f172a;color:#fff}
    .card{width:min(520px,92vw);background:#111827;border:1px solid #1f2937;border-radius:16px;padding:18px}
    h1{margin:0 0 8px;font-size:20px}
    p{margin:0 0 14px;color:#cbd5e1}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    button{flex:1;min-width:180px;border:0;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
    .b1{background:#22c55e}
    .b2{background:#3b82f6}
    .muted{margin-top:10px;font-size:13px;color:#94a3b8}
    .status{margin-top:10px;font-size:14px;color:#e2e8f0}
  </style>
</head>
<body>
  <div class="card">
    <h1>Seu trial acabou</h1>
    <p>Para continuar usando tudo no modo Premium, finalize o pagamento abaixo.</p>

    <div class="row">
      <button class="b1" onclick="pagar('6m')">Liberar 6 meses</button>
      <button class="b2" onclick="pagar('12m')">Liberar 12 meses</button>
    </div>

    <div class="status" id="status"></div>
    <div class="muted">Após pagar, a liberação é automática em segundos.</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    // (A) COLE AQUI seu firebaseConfig (Passo 9.4)
    const firebaseConfig = {
      apiKey: "AIzaSyB36ZszS8v_DeOn3at7zEo_tFq86WU0sI4",
      authDomain: "simulados-concursos-22c91.firebaseapp.com",
      projectId: "simulados-concursos-22c91",
      appId: "1:863699339166:web:8514155da2229b41ae388f",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // (B) COLE AQUI a URL da Function createCheckout (Passo 9.5)
    const CREATE_CHECKOUT_URL = "https://us-central1-simulados-concursos-22c91.cloudfunctions.net/createCheckout";

    // (C) COLE AQUI a URL da Function checkPremium (Passo 9.5)
    const CHECK_PREMIUM_URL = "https://us-central1-simulados-concursos-22c91.cloudfunctions.net/checkPremium";

    const statusEl = document.getElementById("status");
    function setStatus(msg){ statusEl.textContent = msg; }

    async function apiPost(url, body){
      const user = auth.currentUser;
      if(!user) throw new Error("Você precisa estar logado.");
      const token = await user.getIdToken(true);

      const resp = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type":"application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(body || {})
      });

      return await resp.json();
    }

    async function apiGet(url){
      const user = auth.currentUser;
      if(!user) throw new Error("Você precisa estar logado.");
      const token = await user.getIdToken(true);

      const resp = await fetch(url, {
        method: "GET",
        headers: { "Authorization": "Bearer " + token }
      });

      return await resp.json();
    }

    window.pagar = async (planId) => {
      try{
        setStatus("Gerando checkout...");
        const out = await apiPost(CREATE_CHECKOUT_URL, { planId });
        if(!out.ok) throw new Error(out.error || "Falha ao criar checkout");

        setStatus("Redirecionando para pagamento...");
        window.location.href = out.init_point; // Link do checkout MP
      }catch(e){
        setStatus("Erro: " + (e.message || e));
      }
    };

    async function checarPremium(){
      try{
        const out = await apiGet(CHECK_PREMIUM_URL);
        if(out.ok && out.premium){
          // Ajuste a página premium real do seu app
          window.location.href = "/app.html";
        }
      }catch(e){
        // silencioso
      }
    }

    onAuthStateChanged(auth, (user)=>{
      if(!user){
        setStatus("Você precisa estar logado para pagar.");
        return;
      }
      setStatus("Aguardando pagamento...");
      checarPremium();
      setInterval(checarPremium, 4000);
    });
  </script>
</body>
</html>
