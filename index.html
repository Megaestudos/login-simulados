<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Simulados de Concursos</title>

<style>
:root{
--primary:#2563eb;
--primary-dark:#1e40af;
--card:#ffffff;
--text:#0f172a;
--muted:#cbd5f5;
--border:#e2e8f0;
--success:#16a34a;
--warning:#f59e0b;
--danger:#dc2626;
}
*{box-sizing:border-box}
body{
margin:0;
font-family: Inter, system-ui, -apple-system, Arial, sans-serif;
min-height:100vh;
color:#fff;
background:
linear-gradient(rgba(15,23,42,0.70), rgba(15,23,42,0.70)),
url("https://images.pexels.com/photos/990432/pexels-photo-990432.jpeg");
background-size:cover;
background-position:center;
background-attachment:fixed;
}
.page{
min-height:100vh;
display:flex;
align-items:center;
justify-content:center;
padding:24px;
}
.container{
width:100%;
max-width:980px;
display:grid;
grid-template-columns:1.2fr 1fr;
gap:40px;
}
@media(max-width:900px){
.container{grid-template-columns:1fr}
}
.hero h1{font-size:38px;margin:0 0 12px}
.hero p{font-size:18px;color:#e5e7eb}
.hero ul{list-style:none;padding:0}
.hero li{margin:10px 0}
.hero li::before{content:"‚úì ";color:#22c55e}

.card{
background:var(--card);
color:var(--text);
border-radius:20px;
padding:32px;
box-shadow:0 40px 80px rgba(0,0,0,.35);
}
label{font-size:14px;color:#475569}
input{
width:100%;
padding:14px;
margin:6px 0 16px;
border-radius:12px;
border:1px solid var(--border);
font-size:15px;
}
button{
width:100%;
padding:14px;
border-radius:12px;
border:0;
font-size:15px;
cursor:pointer;
}
.btn-primary{background:var(--primary);color:#fff;position:relative;overflow:hidden}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{background:var(--primary-dark)}
.btn-primary:disabled{background:#94a3b8;cursor:not-allowed}
.btn-sec{background:#f1f5f9;margin-top:10px}
.btn-sec:hover{background:#e2e8f0}
.msg{margin-top:14px;font-size:14px;text-align:center;color:var(--danger)}
.msg-success{margin-top:14px;font-size:14px;text-align:center;color:var(--success)}
.hide{
display:none !important;
pointer-events:none !important;
}

.hr{height:1px;background:#e2e8f0;margin:18px 0}
.small{font-size:13px;color:#64748b;line-height:1.35}

.plan-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
.plan{
border:1px solid #e2e8f0;
border-radius:14px;
padding:14px;
background:#fff;
}
.plan .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
.badge{
background:#e0e7ff;
color:#1e40af;
padding:6px 10px;
border-radius:999px;
font-size:13px;
font-weight:700;
}
.reco{
border:2px solid #2563eb;
box-shadow:0 10px 24px rgba(37,99,235,.15);
}
.price{font-size:22px;font-weight:900;color:#0f172a;margin:8px 0 0}
.plan button{margin-top:10px}

.qrWrap{margin-top:10px}
.qrImg{width:100%;max-width:260px;border:1px solid #e2e8f0;border-radius:12px;padding:10px;background:#fff;display:block;margin:0 auto}
.copyRow{display:flex;gap:8px;margin-top:10px}
.copyRow input{margin:0;flex:1}
.copyRow button{width:auto;padding:12px 14px;border-radius:12px;background:#0f172a;color:#fff}
.ok{color:#16a34a}

/* ===== MODAL ===== */
.modal-overlay{
position:fixed;
inset:0;
background:rgba(15,23,42,0.75);
display:flex;
align-items:center;
justify-content:center;
z-index:9999;
}

.modal-box{
background:#fff;
color:#0f172a;
width:100%;
max-width:420px;
border-radius:20px;
padding:28px;
text-align:center;
box-shadow:0 40px 80px rgba(0,0,0,.4);
animation:pop .2s ease-out;
}

.modal-icon{font-size:48px;margin-bottom:10px}
.modal-box h3{margin:0 0 10px;font-size:22px}
.modal-box p{font-size:15px;color:#475569;margin-bottom:18px}
.modal-btn{width:100%;padding:14px;border-radius:12px;border:0;font-size:15px;cursor:pointer}
.modal-btn-primary{background:var(--primary);color:#fff}
.modal-btn-primary:hover{background:var(--primary-dark)}
.modal-btn-secondary{background:#f1f5f9;color:#0f172a}
.modal-btn-secondary:hover{background:#e2e8f0}

@keyframes pop{
from{ transform:scale(.9); opacity:0 }
to{ transform:scale(1); opacity:1 }
}

/* ===== LOADING ANIMATIONS ===== */
@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.5; }
}
.loading-pulse {
animation: pulse 1.5s ease-in-out infinite;
}
@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}
.loading-spinner {
width: 20px;
height: 20px;
border: 2px solid transparent;
border-top-color: currentColor;
border-radius: 50%;
animation: spin 0.8s linear infinite;
display: inline-block;
vertical-align: middle;
margin-right: 8px;
}

/* ===== STATUS BOX ===== */
.status-box{
background: linear-gradient(135deg, #f0fdf4, #dcfce7);
border: 1px solid #86efac;
border-radius: 12px;
padding: 16px;
margin-bottom: 16px;
text-align: center;
}
.status-box.trial{
background: linear-gradient(135deg, #fefce8, #fef9c3);
border-color: #fde047;
}
.status-box.premium{
background: linear-gradient(135deg, #f0f9ff, #bae6fd);
border-color: #7dd3fc;
}

/* ===== PAYMENT STATUS ===== */
.payment-status{
display:flex;
align-items:center;
justify-content:center;
gap:8px;
padding:12px;
border-radius:8px;
margin-top:10px;
font-weight:600;
}
.payment-status.pending{
background:#fef3c7;
color:#92400e;
}
.payment-status.processing{
background:#dbeafe;
color:#1e40af;
animation: pulse 2s ease-in-out infinite;
.debug-panel{
background:#1e293b;
border:2px solid #f59e0b;
border-radius:12px;
padding:16px;
margin-bottom:16px;
font-family:monospace;
font-size:12px;
color:#f59e0b;
}
.payment-status.success{
background:#dcfce7;
color:#166534;
.debug-panel.error{
background:#450a0a;
border-color:#dc2626;
color:#fca5a5;
}
.payment-status.error{
background:#fee2e2;
color:#991b1b;
.debug-panel.success{
background:#064e3b;
border-color:#10b981;
color:#6ee7b7;
}
.hide{display:none !important}

/* ===== TIMER ===== */
.pix-timer{
display:flex;
align-items:center;
justify-content:center;
gap:4px;
font-size:13px;
color:#64748b;
margin-top:8px;
}
.pix-timer span{
font-weight:600;
color:#0f172a;
}
.hr{height:1px;background:#e2e8f0;margin:18px 0}
.small{font-size:13px;color:#64748b;line-height:1.35}
</style>
</head>
<!-- ===== MODAL GLOBAL ===== -->
<div id="modalOverlay" class="modal-overlay hide">
<div class="modal-box">
<div id="modalIcon" class="modal-icon">‚ÑπÔ∏è</div>
<h3 id="modalTitle">T√≠tulo</h3>
<p id="modalMessage">Mensagem</p>
<div id="modalActions" style="display:flex;flex-direction:column;gap:8px"></div>
</div>
</div>

<body>
<div class="page">
<div class="container">

<!-- HERO -->
<div class="hero">
<h1>Prepare-se para concursos<br>com foco total em aprova√ß√£o</h1>
<p>Simulados atualizados, estudo direto ao ponto e acesso imediato.</p>
<ul>
<li>Quest√µes comentadas</li>
<li>Simulados realistas</li>
<li>Conte√∫do focado em prova</li>
<li>Teste gratuito por 48 horas</li>
</ul>
</div>

<!-- CARD -->
<div class="card">
<h2>Acesso √† plataforma</h2>
<p class="small">Entre com sua conta. Se estiver no teste, voc√™ ver√° o tempo restante. Se expirou, voc√™ pode assinar.</p>
<p class="small">Entre com sua conta.</p>

<!-- PAINEL DE DEBUG -->
<div id="debugPanel" class="debug-panel hide">
<div id="debugContent"></div>
</div>

<!-- LOGIN FORM -->
<div id="loginBox">
<label>Email</label>
<input id="email" type="email" placeholder="seu@email.com">

<label>Senha</label>
<div style="position:relative">
<input
id="senha"
type="password"
placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
style="padding-right:44px"
>
<span
id="toggleSenha"
style="
  position:absolute;
  right:14px;
  top:50%;
  transform:translateY(-50%);
  cursor:pointer;
  font-size:18px;
  opacity:.6;
"
title="Mostrar senha"
>üëÅÔ∏è</span>
</div>

<button class="btn-primary" id="btnEntrar">Entrar</button>
<button class="btn-sec" id="btnCriar">Criar conta gratuita</button>
<button
class="btn-sec"
id="btnResetSenha"
style="margin-top:6px"
>
Esqueci minha senha
</button>

<div id="msgLogin" class="msg"></div>
</div>

<!-- STATUS -->
<div id="statusBox" class="hide">
<div class="hr"></div>

<!-- Status Box com informa√ß√µes do plano -->
<div id="statusInfoBox" class="status-box">
<div id="statusText" style="font-weight:900;font-size:18px"></div>
<div id="statusSub" class="small" style="margin-top:6px"></div>
</div>
<div id="statusText" style="font-weight:900;font-size:18px;margin-bottom:8px"></div>
<div id="statusSub" class="small" style="margin-bottom:16px"></div>

<button class="btn-primary" id="btnAcessarApp">
üöÄ Acessar o App
</button>

<button class="btn-sec" id="btnSair">
Sair
</button>
</div>

<!-- PAYWALL -->
<div id="payBox" class="hide">
<div class="hr"></div>

<div style="background:#fef3c7;border:1px solid #fde047;border-radius:12px;padding:14px;margin-bottom:16px">
<div style="font-weight:900;color:#92400e">‚ö†Ô∏è Seu acesso expirou</div>
<div class="small" style="color:#78350f;margin-top:4px">Renove agora para continuar estudando sem interrup√ß√µes.</div>
</div>

<button class="btn-sec" id="btnTrocarConta" style="margin-bottom:16px">
üîÑ Trocar conta
</button>

<div class="small" style="margin-bottom:10px">Escolha um plano:</div>

<div class="plan-grid">
<div class="plan reco">
<div class="top">
<div style="font-weight:900">Plano 6 meses</div>
<span class="badge">Recomendado</span>
</div>
<div class="price">R$ 29,90</div>
<div class="small">Acesso completo por 6 meses.</div>
<button class="btn-primary" id="btnPlano6">Gerar PIX (6 meses)</button>
</div>

<div class="plan">
<div class="top">
<div style="font-weight:900">Plano 1 ano</div>
<span class="badge">Economia</span>
</div>
<div class="price">R$ 49,90</div>
<div class="small">Acesso completo por 12 meses.</div>
<button class="btn-primary" id="btnPlano12">Gerar PIX (1 ano)</button>
</div>
</div>

<!-- QR / PAGAMENTO -->
<div id="qrBox" class="qrWrap hide">
<div class="hr"></div>

<div id="paymentStatusBox" class="payment-status pending">
<span id="paymentStatusIcon">‚è≥</span>
<span id="paymentStatusText">Aguardando pagamento...</span>
</div>

<div id="paymentDetails" style="text-align:center;margin-top:12px">
<div style="font-weight:900" id="qrPlanInfo">Plano 6 meses ‚Äî R$ 29,90</div>
<div class="small" id="qrSub" style="margin-top:4px"></div>
</div>

<img id="qrImg" class="qrImg" alt="QR Code PIX">

<div class="pix-timer" id="pixTimer">
‚è∞ Expira em: <span id="countdown">--:--</span>
</div>

<div class="copyRow">
<input id="pixCopia" readonly>
<button id="btnCopiar">üìã Copiar</button>
</div>

<div id="payMsg" class="small" style="margin-top:12px;text-align:center"></div>

<div style="margin-top:16px;display:flex;gap:8px">
<button class="btn-sec" id="btnCancelarPix" style="flex:1">
Cancelar
</button>
<button class="btn-primary" id="btnRecheck" style="flex:1">
üîÑ Verificar pagamento
</button>
</div>
</div>

</div>
</div>

</div>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";

import {
  getAuth,
  setPersistence,
  browserLocalPersistence,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut,
  sendEmailVerification,
  sendPasswordResetEmail,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

import {
  getFunctions,
  httpsCallable
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-functions.js";


/* ===== CONFIG ===== */
const FRONT_URL = "https://megaestudos.github.io/Quiz-Guarda-Civil-Premium/";
const firebaseConfig = {
apiKey: "AIzaSyB36ZszS8v_DeOn3at7zEo_tFq86WU0sI4",
authDomain: "simulados-concursos-22c91.firebaseapp.com",
projectId: "simulados-concursos-22c91"
};

/* ===== INIT ===== */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Persist√™ncia (UMA VEZ)
await setPersistence(auth, browserLocalPersistence);

const fx = getFunctions(app, "us-central1");

const meCall = httpsCallable(fx, "me");
const createPixChargeCall = httpsCallable(fx, "createPixCharge");
const pixStatusCall = httpsCallable(fx, "pixStatus");

/* ===== UI ===== */
const $ = (id)=>document.getElementById(id);
const show = (boxId)=>{
["loginBox","statusBox","payBox"].forEach(x=>$(x).classList.toggle("hide", x!==boxId));
["loginBox","statusBox"].forEach(x=>$(x).classList.toggle("hide", x!==boxId));
};
function setMsg(t){ $("msgLogin").innerText = t || ""; }

/* ===== MODAL ===== */
function abrirModal(tipo, titulo, mensagem, botoes = null) {
const overlay = $("modalOverlay");
const icon = $("modalIcon");
const title = $("modalTitle");
const msg = $("modalMessage");
const actions = $("modalActions");

const icons = {
sucesso: "‚úÖ",
erro: "‚ùå",
aviso: "‚ö†Ô∏è",
info: "‚ÑπÔ∏è",
pagamento: "üí≥",
carregando: "‚è≥"
};

icon.innerText = icons[tipo] || "‚ÑπÔ∏è";
title.innerText = titulo || "Aviso";
msg.innerText = mensagem || "";

// Bot√µes personalizados ou padr√£o
actions.innerHTML = "";
if (botoes && Array.isArray(botoes)) {
botoes.forEach(btn => {
const button = document.createElement("button");
button.className = btn.primary ? "modal-btn modal-btn-primary" : "modal-btn modal-btn-secondary";
button.innerText = btn.text;
button.onclick = btn.onclick || (() => fecharModal());
actions.appendChild(button);
});
} else {
const button = document.createElement("button");
button.className = "modal-btn modal-btn-primary";
button.innerText = "OK";
button.onclick = () => fecharModal();
actions.appendChild(button);
}

overlay.classList.remove("hide");
}

$("modalOverlay").addEventListener("click", (e) => {
if (e.target.id === "modalOverlay") fecharModal();
});

function fecharModal() {
$("modalOverlay").classList.add("hide");
}

/* ===== UI HELPERS ===== */
function setButtonLoading(buttonId, loading, text = null) {
const btn = $(buttonId);
if (!btn) return;
btn.disabled = loading;
if (loading) {
btn.dataset.originalText = btn.innerText;
btn.innerHTML = `<span class="loading-spinner"></span>Carregando...`;
} else {
btn.innerText = btn.dataset.originalText || text || "OK";
}
}

function updatePaymentStatus(status, message) {
const box = $("paymentStatusBox");
const icon = $("paymentStatusIcon");
const text = $("paymentStatusText");

box.className = "payment-status " + status;
icon.innerText = {
pending: "‚è≥",
processing: "üîÑ",
success: "‚úÖ",
error: "‚ùå"
}[status] || "‚ÑπÔ∏è";
text.innerText = message || "";
}

function startCountdown(expiresAt) {
const timer = $("pixTimer");
const countdown = $("countdown");

if (!expiresAt) {
timer.style.display = "none";
return;
}

timer.style.display = "flex";

function update() {
const now = new Date().getTime();
const expires = new Date(expiresAt).getTime();
const diff = expires - now;

if (diff <= 0) {
countdown.innerText = "00:00";
updatePaymentStatus("error", "PIX expirado! Gere um novo.");
if (pollingTimer) {
clearInterval(pollingTimer);
pollingTimer = null;
}
return;
}

const mins = Math.floor(diff / 60000);
const secs = Math.floor((diff % 60000) / 1000);
countdown.innerText = `${String(mins).padStart(2, "0")}:${String(secs).padStart(2, "0")}`;
}

update();
const interval = setInterval(update, 1000);

return interval;
/* ===== DEBUG ===== */
function debug(msg, isError = false) {
const panel = $("debugPanel");
const content = $("debugContent");
panel.classList.remove("hide", "error", "success");
panel.classList.add(isError ? "error" : "success");
content.innerHTML = `<strong>${isError ? "‚ùå ERRO:" : "‚úÖ"}</strong> ${msg}`;
console.log("[DEBUG]", msg);
}

/* ===== EVENTOS ===== */
$("btnEntrar").addEventListener("click", entrar);
$("btnCriar").addEventListener("click", criarConta);

// PAYWALL / PIX (BOT√ïES)
$("btnPlano6").addEventListener("click", () => gerarPix("6m"));
$("btnPlano12").addEventListener("click", () => gerarPix("12m"));
$("btnCopiar").addEventListener("click", copiarPix);
$("btnCancelarPix").addEventListener("click", cancelarPix);
$("btnRecheck").addEventListener("click", verificarPagamentoManual);

$("btnAcessarApp").addEventListener("click", () => {
console.log("‚û°Ô∏è Acessar app:", FRONT_URL);
window.location.href = FRONT_URL;
});

$("btnTrocarConta").addEventListener("click", async () => {
try {
$("btnSair").addEventListener("click", async () => {
await signOut(auth);
} catch (e) {
console.warn("Erro ao sair:", e);
}

// limpa campos
$("email").value = "";
$("senha").value = "";

// limpa mensagens
setMsg("");
$("payMsg").innerText = "";
$("qrSub").innerText = "";
$("qrBox").classList.add("hide");

// cancela polling do PIX
cancelarPolling();

// volta para login
show("loginBox");
});

// üëÅÔ∏è Mostrar / esconder senha
const toggleSenha = document.getElementById("toggleSenha");
const senhaInput = document.getElementById("senha");

if (toggleSenha && senhaInput) {
toggleSenha.addEventListener("click", () => {
const isPassword = senhaInput.type === "password";
senhaInput.type = isPassword ? "text" : "password";
toggleSenha.innerText = isPassword ? "üôà" : "üëÅÔ∏è";
});
}

document.getElementById("btnResetSenha").addEventListener("click", recuperarSenha);

$("btnSair").addEventListener("click", async () => {
try {
await signOut(auth);
} catch (e) {
console.warn("Erro ao sair:", e);
}

// limpa campos
$("email").value = "";
$("senha").value = "";

// limpa mensagens
setMsg("");
$("payMsg").innerText = "";
$("qrSub").innerText = "";
$("qrBox").classList.add("hide");

// cancela polling se existir
cancelarPolling();

// volta para login
show("loginBox");
});

/* ===== LOGIN ===== */
async function entrar() {
try {
setMsg("");
const email = $("email").value.trim();
const senha = $("senha").value;

if (!email || !senha) {
setMsg("Preencha e-mail e senha.");
return;
}

setButtonLoading("btnEntrar", true);
await signInWithEmailAndPassword(auth, email, senha);
// ‚úÖ IMPORTANTE: Carregar status ap√≥s login bem-sucedido
await carregarStatus();

} catch (e) {
console.error("Erro ao entrar:", e);
abrirModal(
"erro",
"Erro ao entrar",
"E-mail ou senha inv√°lidos. Verifique os dados e tente novamente."
);
} finally {
setButtonLoading("btnEntrar", false);
}
}

async function criarConta(){
try{
setMsg("");
const email = $("email").value.trim();
const senha = $("senha").value;
if(!email || !senha){ setMsg("Preencha email e senha."); return; }

setButtonLoading("btnCriar", true);
await createUserWithEmailAndPassword(auth, email, senha);

// üîê ENVIA E-MAIL DE VERIFICA√á√ÉO
await sendEmailVerification(auth.currentUser);
debug("Tentando fazer login com: " + email);
$("btnEntrar").innerText = "Carregando...";
$("btnEntrar").disabled = true;

// ‚ö†Ô∏è AVISA O USU√ÅRIO
setMsg("Enviamos um e-mail de verifica√ß√£o. Confirme antes de comprar.");

setButtonLoading("btnCriar", false);
return;
try {
debug("Chamando Firebase Auth...");
await signInWithEmailAndPassword(auth, email, senha);
debug("Firebase Auth OK!");

}catch(e){
console.error("Erro criar conta:", e);
setMsg(e?.message || "Erro ao criar conta");
setButtonLoading("btnCriar", false);
}
}
debug("Chamando Cloud Function 'me'...");
const resp = await meCall();
const data = resp.data;

/* ===== STATUS ===== */
async function carregarStatus() {
  const user = auth.currentUser;
  if (!user) {
    show("loginBox");
    return;
  }

  let data;
  try {
    const resp = await meCall();
    data = resp.data;
  } catch (e) {
    console.error("Erro meCall:", e);
    setMsg("Falha ao validar sess√£o.");
    show("loginBox");
    return;
  }

  debug("Cloud Function retornou: " + JSON.stringify(data));

  if (!data.authenticated) {
    show("loginBox");
    setMsg("Sess√£o inv√°lida.");
    return;
  }

  if (data.emailVerified === false) {
    show("statusBox");
    $("statusText").innerText = "‚ö†Ô∏è E-mail n√£o confirmado";
    $("statusSub").innerText = "Confirme o e-mail para continuar.";
    return;
  }

  const status = data.entitled ? data.plan : "none";
  const fim = data.expiresAt ? new Date(data.expiresAt) : null;

  if (status === "trial" || status === "premium") {
    show("statusBox");

    const box = $("statusInfoBox");
    box.className = "status-box " + status;

    $("statusText").innerText =
      status === "trial" ? "üïê Teste gr√°tis ativo" : "‚úÖ Acesso Premium ativo";

    $("statusSub").innerText = fim
      ? "V√°lido at√©: " + fim.toLocaleString()
      : "";

    return;
  }

  show("payBox");
}

/* ===== PIX ===== */
let pollingTimer = null;
let countdownInterval = null;
let currentTxid = null;
let currentPlan = null;
let retryCount = 0;
const MAX_RETRIES = 3;

async function gerarPix(plan) {
try {
const user = auth.currentUser;
if (!user) {
show("loginBox");
setMsg("Fa√ßa login.");
return;
}

// UI inicial
$("qrBox").classList.remove("hide");
$("payMsg").innerText = "";
$("qrSub").innerText = "";

updatePaymentStatus("processing", "Gerando PIX...");

console.log("üöÄ gerarPix:", plan);

// Desabilita bot√µes de plano
$("btnPlano6").disabled = true;
$("btnPlano12").disabled = true;

setButtonLoading(`btnPlano${plan === "6m" ? "6" : "12"}`, true);

// üî• chamada correta da Cloud Function
const resp = await createPixChargeCall({ plan });
const data = resp.data;

if (data.alreadyEntitled) {
$("qrSub").innerText = "Seu acesso j√° est√° ativo. Abrindo o app...";
abrirModal(
"sucesso",
"Acesso ativo!",
"Seu acesso premium j√° est√° ativo. Redirecionando para o app...",
[
{
text: "Ir para o app",
primary: true,
onclick: () => {
window.location.href = FRONT_URL;
}
}
]
);
setTimeout(() => (location.href = FRONT_URL), 2000);
return;
}

// Armazena dados para polling
currentTxid = data.txid;
currentPlan = plan;

// Exibe QR Code
$("qrPlanInfo").innerText = `Plano ${plan === "6m" ? "6 meses" : "1 ano"} ‚Äî R$ ${String(data.price).replace(".", ",")}`;
$("qrSub").innerText = "Escaneie o QR Code ou copie o c√≥digo";

$("qrImg").src = "data:image/png;base64," + data.qrcodeImage;
$("pixCopia").value = data.copiaecola;

updatePaymentStatus("pending", "Aguardando pagamento...");

$("payMsg").innerHTML = "<span style='color:#64748b'>Escaneie com o app do seu banco ou cole o c√≥digo PIX.</span>";

// Inicia countdown
if (countdownInterval) clearInterval(countdownInterval);
countdownInterval = startCountdown(data.expiresAt);

// Habilita bot√µes novamente
$("btnPlano6").disabled = false;
$("btnPlano12").disabled = false;
setButtonLoading(`btnPlano${plan === "6m" ? "6" : "12"}`, false);

// Inicia polling
iniciarPolling(data.txid);

} catch (e) {
console.error("‚ùå ERRO gerarPix:", e);

// Habilita bot√µes
$("btnPlano6").disabled = false;
$("btnPlano12").disabled = false;
setButtonLoading("btnPlano6", false);
setButtonLoading("btnPlano12", false);

let msg = "Erro ao gerar PIX. Tente novamente.";

if (e?.code === "functions/unauthenticated") {
msg = "Sess√£o expirada. Fa√ßa login novamente.";
show("loginBox");
} else if (e?.code === "functions/failed-precondition") {
msg = e.message || "Confirme seu e-mail antes de comprar.";
} else if (e?.code === "functions/invalid-argument") {
msg = "Plano inv√°lido. Atualize a p√°gina.";
} else if (e?.code === "functions/internal") {
msg = "Erro interno no servidor. Tente novamente em instantes.";
} else if (e?.message) {
msg = e.message;
}

updatePaymentStatus("error", msg);
$("payMsg").innerText = msg;
}
}

function iniciarPolling(txid) {
cancelarPolling();

console.log("üì° Iniciando polling para txid:", txid);

// Primeira verifica√ß√£o imediata
verificarPagamento(txid);

// Intervalo de 5 segundos
pollingTimer = setInterval(() => {
verificarPagamento(txid);
}, 5000);
}

function cancelarPolling() {
if (pollingTimer) {
clearInterval(pollingTimer);
pollingTimer = null;
}
if (countdownInterval) {
clearInterval(countdownInterval);
countdownInterval = null;
}
currentTxid = null;
currentPlan = null;
retryCount = 0;
}

async function verificarPagamento(txid) {
if (!txid) return;

try {
const resp = await pixStatusCall({ txid });
const data = resp.data;

console.log("üìä Status do PIX:", data);

if (data.paid) {
pagamentoConfirmado();
return;
}

if (data.expired) {
updatePaymentStatus("error", "PIX expirado!");
$("payMsg").innerText = "O prazo para pagamento expirou. Gere um novo PIX.";
cancelarPolling();
return;
}

// Status em andamento
if (data.status) {
updatePaymentStatus("pending", `Status: ${data.status}`);
}

retryCount = 0;

} catch (e) {
console.error("‚ùå Erro ao verificar pagamento:", e);
retryCount++;

if (retryCount >= MAX_RETRIES) {
updatePaymentStatus("error", "Erro ao verificar. Tente novamente.");
$("payMsg").innerText = "Problema na conex√£o. Clique em 'Verificar pagamento'.";
cancelarPolling();
} else {
updatePaymentStatus("processing", "Verificando...");
}
}
}

async function verificarPagamentoManual() {
if (!currentTxid) {
abrirModal("aviso", "Nenhum PIX", "Gere um PIX primeiro.");
return;
$("statusText").innerText = "‚ùå Sem acesso";
$("statusSub").innerText = "Voc√™ precisa fazer o teste ou assinar.";
}

updatePaymentStatus("processing", "Verificando...");
retryCount = 0;
await verificarPagamento(currentTxid);
debug("Login OK!");

// Reinicia polling se ainda n√£o expirou
if (currentTxid && countdownInterval) {
iniciarPolling(currentTxid);
}
}

function pagamentoConfirmado() {
cancelarPolling();

updatePaymentStatus("success", "Pagamento confirmado!");

abrirModal(
"sucesso",
"üéâ Pagamento realizado!",
"Seu acesso premium foi ativado com sucesso. Voc√™ pode acessar agora.",
[
{
text: "Acessar o App",
primary: true,
onclick: () => {
window.location.href = FRONT_URL;
}
},
{
text: "Ver meu acesso",
primary: false,
onclick: () => {
carregarStatus();
fecharModal();
}
}
]
);

// Limpa campos do PIX
$("pixCopia").value = "";
$("qrImg").src = "";
$("qrBox").classList.add("hide");
}

async function copiarPix() {
const txt = $("pixCopia").value || "";
if (!txt) return;

try {
await navigator.clipboard.writeText(txt);
$("payMsg").innerHTML = "<span class='ok'>‚úÖ C√≥digo PIX copiado!</span>";
} catch (e) {
$("pixCopia").focus();
$("pixCopia").select();
document.execCommand("copy");
$("payMsg").innerHTML = "<span class='ok'>‚úÖ C√≥digo PIX copiado!</span>";
console.error("Erro completo:", e);
debug("ERRO: " + e.message + " (c√≥digo: " + e.code + ")", true);
setMsg(e?.message || "Erro ao fazer login");
} finally {
$("btnEntrar").innerText = "Entrar";
$("btnEntrar").disabled = false;
}
}

function cancelarPix() {
  cancelarPolling();
  updatePaymentStatus("pending", "PIX cancelado");
}
/* ===== CRIAR CONTA ===== */
async function criarConta(){
const email = $("email").value.trim();
const senha = $("senha").value;

if(!email || !senha){ setMsg("Preencha email e senha."); return; }

$("qrBox").classList.add("hide");
$("payMsg").innerText = "";
debug("Criando conta: " + email);
$("btnCriar").innerText = "Carregando...";
$("btnCriar").disabled = true;

abrirModal(
"info",
"PIX cancelado",
"Voc√™ pode gerar um novo PIX quando quiser.",
[
{
text: "OK",
primary: true,
onclick: () => fecharModal()
try{
await createUserWithEmailAndPassword(auth, email, senha);
await sendEmailVerification(auth.currentUser);
debug("Conta criada! Verifique seu e-mail.");
setMsg("Enviamos um e-mail de verifica√ß√£o. Confirme antes de comprar.");
}catch(e){
console.error("Erro criar conta:", e);
debug("ERRO: " + e.message, true);
setMsg(e?.message || "Erro ao criar conta");
} finally {
$("btnCriar").innerText = "Criar conta gratuita";
$("btnCriar").disabled = false;
}
]
);
}

/* ===== START ===== */
onAuthStateChanged(auth, (user) => {
  if (!user) {
    show("loginBox");
    return;
  }
  carregarStatus();
});

async function recuperarSenha() {
const email = $("email").value.trim();
if (!email) {
abrirModal(
"aviso",
"E-mail obrigat√≥rio",
"Digite seu e-mail para receber o link de redefini√ß√£o de senha."
);
return;
}

try {
await sendPasswordResetEmail(auth, email);
abrirModal(
"sucesso",
"E-mail enviado",
"Se este e-mail estiver cadastrado, voc√™ receber√° um link para redefinir a senha."
);
} catch (e) {
abrirModal(
"erro",
"Erro",
"N√£o foi poss√≠vel enviar o e-mail. Verifique o endere√ßo informado."
);
}
}

// estado inicial SEMPRE √© login
// estado inicial
show("loginBox");

debug("P√°gina carregada. Ready!");
</script>
</body>
</html>


