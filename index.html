<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Simulados de Concursos</title>

<style>
:root{
--primary:#2563eb;
--primary-dark:#1e40af;
--card:#ffffff;
--text:#0f172a;
--muted:#cbd5f5;
--border:#e2e8f0;
--success:#16a34a;
--warning:#f59e0b;
--danger:#dc2626;
}
*{box-sizing:border-box}
body{
margin:0;
font-family: Inter, system-ui, -apple-system, Arial, sans-serif;
min-height:100vh;
color:#fff;
background:
linear-gradient(rgba(15,23,42,0.70), rgba(15,23,42,0.70)),
url("https://images.pexels.com/photos/990432/pexels-photo-990432.jpeg");
background-size:cover;
background-position:center;
background-attachment:fixed;
}
.page{
min-height:100vh;
display:flex;
align-items:center;
justify-content:center;
padding:24px;
}
.container{
width:100%;
max-width:980px;
display:grid;
grid-template-columns:1.2fr 1fr;
gap:40px;
}
@media(max-width:900px){
.container{grid-template-columns:1fr}
}
.hero h1{font-size:38px;margin:0 0 12px}
.hero p{font-size:18px;color:#e5e7eb}
.hero ul{list-style:none;padding:0}
.hero li{margin:10px 0}
.hero li::before{content:"‚úì ";color:#22c55e}

.card{
background:var(--card);
color:var(--text);
border-radius:20px;
padding:32px;
box-shadow:0 40px 80px rgba(0,0,0,.35);
}
label{font-size:14px;color:#475569}
input{
width:100%;
padding:14px;
margin:6px 0 16px;
border-radius:12px;
border:1px solid var(--border);
font-size:15px;
}
button{
width:100%;
padding:14px;
border-radius:12px;
border:0;
font-size:15px;
cursor:pointer;
}
.btn-primary{background:var(--primary);color:#fff;position:relative;overflow:hidden}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{background:var(--primary-dark)}
.btn-primary:disabled{background:#94a3b8;cursor:not-allowed}
.btn-sec{background:#f1f5f9;margin-top:10px}
.btn-sec:hover{background:#e2e8f0}
.msg{margin-top:14px;font-size:14px;text-align:center;color:var(--danger)}
.msg-success{margin-top:14px;font-size:14px;text-align:center;color:var(--success)}
.hide{
display:none !important;
pointer-events:none !important;
}

.hr{height:1px;background:#e2e8f0;margin:18px 0}
.small{font-size:13px;color:#64748b;line-height:1.35}

.plan-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
.plan{
border:1px solid #e2e8f0;
border-radius:14px;
padding:14px;
background:#fff;
}
.plan .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
.badge{
background:#e0e7ff;
color:#1e40af;
padding:6px 10px;
border-radius:999px;
font-size:13px;
font-weight:700;
}
.reco{
border:2px solid #2563eb;
box-shadow:0 10px 24px rgba(37,99,235,.15);
}
.price{font-size:22px;font-weight:900;color:#0f172a;margin:8px 0 0}
.plan button{margin-top:10px}

.qrWrap{margin-top:10px}
.qrImg{width:100%;max-width:260px;border:1px solid #e2e8f0;border-radius:12px;padding:10px;background:#fff;display:block;margin:0 auto}
.copyRow{display:flex;gap:8px;margin-top:10px}
.copyRow input{margin:0;flex:1}
.copyRow button{width:auto;padding:12px 14px;border-radius:12px;background:#0f172a;color:#fff}
.ok{color:#16a34a}

/* ===== MODAL ===== */
.modal-overlay{
position:fixed;
inset:0;
background:rgba(15,23,42,0.75);
display:flex;
align-items:center;
justify-content:center;
z-index:9999;
}

.modal-box{
background:#fff;
color:#0f172a;
width:100%;
max-width:420px;
border-radius:20px;
padding:28px;
text-align:center;
box-shadow:0 40px 80px rgba(0,0,0,.4);
animation:pop .2s ease-out;
}

.modal-icon{font-size:48px;margin-bottom:10px}
.modal-box h3{margin:0 0 10px;font-size:22px}
.modal-box p{font-size:15px;color:#475569;margin-bottom:18px}
.modal-btn{width:100%;padding:14px;border-radius:12px;border:0;font-size:15px;cursor:pointer}
.modal-btn-primary{background:var(--primary);color:#fff}
.modal-btn-primary:hover{background:var(--primary-dark)}
.modal-btn-secondary{background:#f1f5f9;color:#0f172a}
.modal-btn-secondary:hover{background:#e2e8f0}

@keyframes pop{
from{ transform:scale(.9); opacity:0 }
to{ transform:scale(1); opacity:1 }
}

/* ===== LOADING ANIMATIONS ===== */
@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.5; }
}
.loading-pulse {
animation: pulse 1.5s ease-in-out infinite;
}
@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}
.loading-spinner {
width: 20px;
height: 20px;
border: 2px solid transparent;
border-top-color: currentColor;
border-radius: 50%;
animation: spin 0.8s linear infinite;
display: inline-block;
vertical-align: middle;
margin-right: 8px;
}

/* ===== STATUS BOX ===== */
.status-box{
background: linear-gradient(135deg, #f0fdf4, #dcfce7);
border: 1px solid #86efac;
border-radius: 12px;
padding: 16px;
margin-bottom: 16px;
text-align: center;
}
.status-box.trial{
background: linear-gradient(135deg, #fefce8, #fef9c3);
border-color: #fde047;
}
.status-box.premium{
background: linear-gradient(135deg, #f0f9ff, #bae6fd);
border-color: #7dd3fc;
}

/* ===== PAYMENT STATUS ===== */
.payment-status{
display:flex;
align-items:center;
justify-content:center;
gap:8px;
padding:12px;
border-radius:8px;
margin-top:10px;
font-weight:600;
}
.payment-status.pending{
background:#fef3c7;
color:#92400e;
}
.payment-status.processing{
background:#dbeafe;
color:#1e40af;
animation: pulse 2s ease-in-out infinite;
.debug-panel{
background:#1e293b;
border:2px solid #f59e0b;
border-radius:12px;
padding:16px;
margin-bottom:16px;
font-family:monospace;
font-size:12px;
color:#f59e0b;
}
.payment-status.success{
background:#dcfce7;
color:#166534;
.debug-panel.error{
background:#450a0a;
border-color:#dc2626;
color:#fca5a5;
}
.payment-status.error{
background:#fee2e2;
color:#991b1b;
.debug-panel.success{
background:#064e3b;
border-color:#10b981;
color:#6ee7b7;
}
.hide{display:none !important}

/* ===== TIMER ===== */
.pix-timer{
display:flex;
align-items:center;
justify-content:center;
gap:4px;
font-size:13px;
color:#64748b;
margin-top:8px;
}
.pix-timer span{
font-weight:600;
color:#0f172a;
}
.hr{height:1px;background:#e2e8f0;margin:18px 0}
.small{font-size:13px;color:#64748b;line-height:1.35}
</style>
</head>
<!-- ===== MODAL GLOBAL ===== -->
<div id="modalOverlay" class="modal-overlay hide">
<div class="modal-box">
<div id="modalIcon" class="modal-icon">‚ÑπÔ∏è</div>
<h3 id="modalTitle">T√≠tulo</h3>
<p id="modalMessage">Mensagem</p>
<div id="modalActions" style="display:flex;flex-direction:column;gap:8px"></div>
</div>
</div>

<body>
<div class="page">
<div class="container">

<!-- HERO -->
<div class="hero">
<h1>Prepare-se para concursos<br>com foco total em aprova√ß√£o</h1>
<p>Simulados atualizados, estudo direto ao ponto e acesso imediato.</p>
<ul>
<li>Quest√µes comentadas</li>
<li>Simulados realistas</li>
<li>Conte√∫do focado em prova</li>
<li>Teste gratuito por 48 horas</li>
</ul>
</div>

<!-- CARD -->
<div class="card">
<h2>Acesso √† plataforma</h2>
<p class="small">Entre com sua conta. Se estiver no teste, voc√™ ver√° o tempo restante. Se expirou, voc√™ pode assinar.</p>
<p class="small">Entre com sua conta.</p>

<!-- PAINEL DE DEBUG -->
<div id="debugPanel" class="debug-panel hide">
<div id="debugContent"></div>
</div>

<!-- LOGIN FORM -->
<div id="loginBox">
<label>Email</label>
<input id="email" type="email" placeholder="seu@email.com">

<label>Senha</label>
<div style="position:relative">
<input
id="senha"
type="password"
placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
style="padding-right:44px"
>
<span
id="toggleSenha"
style="
  position:absolute;
  right:14px;
  top:50%;
  transform:translateY(-50%);
  cursor:pointer;
  font-size:18px;
  opacity:.6;
"
title="Mostrar senha"
>üëÅÔ∏è</span>
</div>

<button class="btn-primary" id="btnEntrar">Entrar</button>
<button class="btn-sec" id="btnCriar">Criar conta gratuita</button>
<button
class="btn-sec"
id="btnResetSenha"
style="margin-top:6px"
>
Esqueci minha senha
</button>

<div id="msgLogin" class="msg"></div>
</div>

<!-- STATUS -->
<div id="statusBox" class="hide">
<div class="hr"></div>

<!-- Status Box com informa√ß√µes do plano -->
<div id="statusInfoBox" class="status-box">
<div id="statusText" style="font-weight:900;font-size:18px"></div>
<div id="statusSub" class="small" style="margin-top:6px"></div>
</div>
<div id="statusText" style="font-weight:900;font-size:18px;margin-bottom:8px"></div>
<div id="statusSub" class="small" style="margin-bottom:16px"></div>

<button class="btn-primary" id="btnAcessarApp">
üöÄ Acessar o App
</button>

<button class="btn-sec" id="btnSair">
Sair
</button>
</div>

<!-- PAYWALL -->
<div id="payBox" class="hide">
<div class="hr"></div>

<div style="background:#fef3c7;border:1px solid #fde047;border-radius:12px;padding:14px;margin-bottom:16px">
<div style="font-weight:900;color:#92400e">‚ö†Ô∏è Seu acesso expirou</div>
<div class="small" style="color:#78350f;margin-top:4px">Renove agora para continuar estudando sem interrup√ß√µes.</div>
</div>

<button class="btn-sec" id="btnTrocarConta" style="margin-bottom:16px">
üîÑ Trocar conta
</button>

<div class="small" style="margin-bottom:10px">Escolha um plano:</div>

<div class="plan-grid">
<div class="plan reco">
<div class="top">
<div style="font-weight:900">Plano 6 meses</div>
<span class="badge">Recomendado</span>
</div>
<div class="price">R$ 29,90</div>
<div class="small">Acesso completo por 6 meses.</div>
<button class="btn-primary" id="btnPlano6">Gerar PIX (6 meses)</button>
</div>

<div class="plan">
<div class="top">
<div style="font-weight:900">Plano 1 ano</div>
<span class="badge">Economia</span>
</div>
<div class="price">R$ 49,90</div>
<div class="small">Acesso completo por 12 meses.</div>
<button class="btn-primary" id="btnPlano12">Gerar PIX (1 ano)</button>
</div>
</div>

<!-- QR / PAGAMENTO -->
<div id="qrBox" class="qrWrap hide">
<div class="hr"></div>

<div id="paymentStatusBox" class="payment-status pending">
<span id="paymentStatusIcon">‚è≥</span>
<span id="paymentStatusText">Aguardando pagamento...</span>
</div>

<div id="paymentDetails" style="text-align:center;margin-top:12px">
<div style="font-weight:900" id="qrPlanInfo">Plano 6 meses ‚Äî R$ 29,90</div>
<div class="small" id="qrSub" style="margin-top:4px"></div>
</div>

<img id="qrImg" class="qrImg" alt="QR Code PIX">

<div class="pix-timer" id="pixTimer">
‚è∞ Expira em: <span id="countdown">--:--</span>
</div>

<div class="copyRow">
<input id="pixCopia" readonly>
<button id="btnCopiar">üìã Copiar</button>
</div>

<div id="payMsg" class="small" style="margin-top:12px;text-align:center"></div>

<div style="margin-top:16px;display:flex;gap:8px">
<button class="btn-sec" id="btnCancelarPix" style="flex:1">
Cancelar
</button>
<button class="btn-primary" id="btnRecheck" style="flex:1">
üîÑ Verificar pagamento
</button>
</div>
</div>

</div>
</div>

</div>
</div>

</div>
</div>

<script type="module">
/* =========================
   FIREBASE IMPORTS (OK)
========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getAuth,
  setPersistence,
  browserLocalPersistence,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut,
  sendEmailVerification,
  sendPasswordResetEmail,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-functions.js";

/* =========================
   CONFIG
========================= */
const FRONT_URL = "https://megaestudos.github.io/Quiz-Guarda-Civil-Premium/";
const firebaseConfig = {
  apiKey: "AIzaSyB36ZszS8v_DeOn3at7zEo_tFq86WU0sI4",
  authDomain: "simulados-concursos-22c91.firebaseapp.com",
  projectId: "simulados-concursos-22c91"
};

const FUNCTIONS_REGION = "us-central1";

/* =========================
   INIT
========================= */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
await setPersistence(auth, browserLocalPersistence);

const fx = getFunctions(app, FUNCTIONS_REGION);
const meCall = httpsCallable(fx, "me");
const createPixChargeCall = httpsCallable(fx, "createPixCharge");
const pixStatusCall = httpsCallable(fx, "pixStatus");

/* =========================
   UI HELPERS
========================= */
const $ = (id) => document.getElementById(id);

function show(boxId) {
  const boxes = ["loginBox", "statusBox", "payBox"];
  boxes.forEach((b) => {
    const el = $(b);
    if (!el) return;
    el.classList.toggle("hide", b !== boxId);
  });
}

function setMsg(text) {
  const el = $("msgLogin");
  if (el) el.innerText = text || "";
}

function setButtonLoading(buttonId, loading, fallbackText = null) {
  const btn = $(buttonId);
  if (!btn) return;
  btn.disabled = !!loading;
  if (loading) {
    btn.dataset.originalText = btn.innerText;
    btn.innerHTML = `<span class="loading-spinner"></span>Carregando...`;
  } else {
    btn.innerText = btn.dataset.originalText || fallbackText || btn.innerText || "OK";
  }
}

/* =========================
   DEBUG PANEL
========================= */
function debug(msg, isError = false) {
  const panel = $("debugPanel");
  const content = $("debugContent");
  if (!panel || !content) return;

  panel.classList.remove("hide");
  panel.classList.remove("error", "success");
  panel.classList.add(isError ? "error" : "success");
  content.innerHTML = `<strong>${isError ? "‚ùå ERRO:" : "‚úÖ"}</strong> ${msg}`;

  console.log(isError ? "[DEBUG:ERROR]" : "[DEBUG:OK]", msg);
}

/* =========================
   MODAL
========================= */
function abrirModal(tipo, titulo, mensagem, botoes = null) {
  const overlay = $("modalOverlay");
  const icon = $("modalIcon");
  const title = $("modalTitle");
  const msg = $("modalMessage");
  const actions = $("modalActions");

  if (!overlay || !icon || !title || !msg || !actions) return;

  const icons = {
    sucesso: "‚úÖ",
    erro: "‚ùå",
    aviso: "‚ö†Ô∏è",
    info: "‚ÑπÔ∏è",
    pagamento: "üí≥",
    carregando: "‚è≥"
  };

  icon.innerText = icons[tipo] || "‚ÑπÔ∏è";
  title.innerText = titulo || "Aviso";
  msg.innerText = mensagem || "";

  actions.innerHTML = "";

  if (botoes && Array.isArray(botoes) && botoes.length) {
    botoes.forEach((btn) => {
      const b = document.createElement("button");
      b.className = btn.primary ? "modal-btn modal-btn-primary" : "modal-btn modal-btn-secondary";
      b.innerText = btn.text || "OK";
      b.onclick = () => {
        try {
          if (typeof btn.onclick === "function") btn.onclick();
        } finally {
          // se o bot√£o n√£o quiser fechar, ele pode chamar fecharModal() manualmente
          if (!btn.keepOpen) fecharModal();
        }
      };
      actions.appendChild(b);
    });
  } else {
    const b = document.createElement("button");
    b.className = "modal-btn modal-btn-primary";
    b.innerText = "OK";
    b.onclick = () => fecharModal();
    actions.appendChild(b);
  }

  overlay.classList.remove("hide");
}

function fecharModal() {
  const overlay = $("modalOverlay");
  if (overlay) overlay.classList.add("hide");
}

(() => {
  const overlay = $("modalOverlay");
  if (overlay) {
    overlay.addEventListener("click", (e) => {
      if (e.target && e.target.id === "modalOverlay") fecharModal();
    });
  }
})();

/* =========================
   PAYMENT UI
========================= */
function updatePaymentStatus(status, message) {
  const box = $("paymentStatusBox");
  const icon = $("paymentStatusIcon");
  const text = $("paymentStatusText");
  if (!box || !icon || !text) return;

  box.className = "payment-status " + (status || "pending");
  icon.innerText = {
    pending: "‚è≥",
    processing: "üîÑ",
    success: "‚úÖ",
    error: "‚ùå"
  }[status] || "‚ÑπÔ∏è";
  text.innerText = message || "";
}

let pollingTimer = null;
let countdownInterval = null;
let currentTxid = null;
let retryCount = 0;
const MAX_RETRIES = 3;

function cancelarPolling() {
  if (pollingTimer) {
    clearInterval(pollingTimer);
    pollingTimer = null;
  }
  if (countdownInterval) {
    clearInterval(countdownInterval);
    countdownInterval = null;
  }
  currentTxid = null;
  retryCount = 0;
}

function startCountdown(expiresAtIso) {
  const timer = $("pixTimer");
  const countdown = $("countdown");
  if (!timer || !countdown) return null;

  if (!expiresAtIso) {
    timer.style.display = "none";
    return null;
  }

  timer.style.display = "flex";

  const tick = () => {
    const now = Date.now();
    const expires = new Date(expiresAtIso).getTime();
    const diff = expires - now;

    if (Number.isNaN(expires)) {
      countdown.innerText = "--:--";
      return;
    }

    if (diff <= 0) {
      countdown.innerText = "00:00";
      updatePaymentStatus("error", "PIX expirado! Gere um novo.");
      cancelarPolling();
      return;
    }

    const mins = Math.floor(diff / 60000);
    const secs = Math.floor((diff % 60000) / 1000);
    countdown.innerText = `${String(mins).padStart(2, "0")}:${String(secs).padStart(2, "0")}`;
  };

  tick();
  return setInterval(tick, 1000);
}

/* =========================
   AUTH / STATUS
========================= */
async function carregarStatus() {
  const user = auth.currentUser;
  if (!user) {
    show("loginBox");
    return;
  }

  let data;
  try {
    const resp = await meCall();
    data = resp.data;
  } catch (e) {
    console.error("Erro meCall:", e);
    debug("Falha ao chamar fun√ß√£o 'me': " + (e?.message || "erro desconhecido"), true);
    show("loginBox");
    setMsg("Falha ao validar sess√£o. Fa√ßa login novamente.");
    return;
  }

  debug("me() => " + JSON.stringify(data));

  if (!data || data.authenticated !== true) {
    show("loginBox");
    setMsg("Sess√£o inv√°lida. Fa√ßa login novamente.");
    return;
  }

  // Email n√£o confirmado
  if (data.emailVerified === false) {
    show("statusBox");
    const st = $("statusText");
    const sb = $("statusSub");
    if (st) st.innerText = "‚ö†Ô∏è E-mail n√£o confirmado";
    if (sb) sb.innerText = "Confirme seu e-mail para liberar compra e acesso.";

    abrirModal(
      "aviso",
      "Confirme seu e-mail",
      "Voc√™ precisa confirmar o e-mail antes de comprar. Verifique a caixa de entrada e o spam."
    );
    return;
  }

  // Com acesso (trial/premium)
  const status = data.entitled ? data.plan : "none";
  const fim = data.expiresAt ? new Date(data.expiresAt) : null;

  if (status === "trial" || status === "premium") {
    show("statusBox");

    const box = $("statusInfoBox");
    if (box) box.className = "status-box " + status;

    const st = $("statusText");
    const sb = $("statusSub");

    if (st) st.innerText = status === "trial" ? "üïê Teste gr√°tis ativo" : "‚úÖ Acesso Premium ativo";
    if (sb) sb.innerText = fim ? ("V√°lido at√©: " + fim.toLocaleString()) : "";

    return;
  }

  // Sem acesso => paywall
  show("payBox");
}

/* =========================
   ACTIONS: LOGIN / LOGOUT / SIGNUP / RESET
========================= */
async function entrar() {
  setMsg("");

  const email = ($("email")?.value || "").trim();
  const senha = $("senha")?.value || "";

  if (!email || !senha) {
    setMsg("Preencha e-mail e senha.");
    return;
  }

  setButtonLoading("btnEntrar", true);

  try {
    await signInWithEmailAndPassword(auth, email, senha);
    debug("Auth OK (signInWithEmailAndPassword)");
    await carregarStatus();
  } catch (e) {
    console.error("Erro ao entrar:", e);
    debug("Falha no login: " + (e?.message || "erro desconhecido"), true);

    abrirModal(
      "erro",
      "Erro ao entrar",
      "E-mail ou senha inv√°lidos, ou a conta n√£o existe."
    );
  } finally {
    setButtonLoading("btnEntrar", false, "Entrar");
  }
}

async function criarConta() {
  setMsg("");

  const email = ($("email")?.value || "").trim();
  const senha = $("senha")?.value || "";

  if (!email || !senha) {
    setMsg("Preencha e-mail e senha.");
    return;
  }

  setButtonLoading("btnCriar", true);

  try {
    await createUserWithEmailAndPassword(auth, email, senha);
    debug("Conta criada no Firebase Auth");

    // envia verifica√ß√£o
    await sendEmailVerification(auth.currentUser);
    debug("E-mail de verifica√ß√£o enviado");

    abrirModal(
      "sucesso",
      "Conta criada",
      "Enviamos um e-mail de verifica√ß√£o. Confirme antes de comprar."
    );

    show("loginBox");
    setMsg("Confirme seu e-mail antes de comprar.");
  } catch (e) {
    console.error("Erro criar conta:", e);
    debug("Falha ao criar conta: " + (e?.message || "erro desconhecido"), true);

    abrirModal(
      "erro",
      "Erro ao criar conta",
      e?.message || "N√£o foi poss√≠vel criar a conta."
    );
  } finally {
    setButtonLoading("btnCriar", false, "Criar conta gratuita");
  }
}

async function sair() {
  try {
    await signOut(auth);
  } catch (e) {
    console.warn("Erro ao sair:", e);
  } finally {
    // limpa UI
    if ($("email")) $("email").value = "";
    if ($("senha")) $("senha").value = "";

    setMsg("");
    if ($("payMsg")) $("payMsg").innerText = "";
    if ($("qrSub")) $("qrSub").innerText = "";
    if ($("qrBox")) $("qrBox").classList.add("hide");
    if ($("pixCopia")) $("pixCopia").value = "";
    if ($("qrImg")) $("qrImg").src = "";

    cancelarPolling();
    show("loginBox");
  }
}

async function recuperarSenha() {
  const email = ($("email")?.value || "").trim();
  if (!email) {
    abrirModal("aviso", "E-mail obrigat√≥rio", "Digite seu e-mail para receber o link de redefini√ß√£o.");
    return;
  }

  try {
    await sendPasswordResetEmail(auth, email);
    abrirModal("sucesso", "E-mail enviado", "Se o e-mail estiver cadastrado, voc√™ receber√° o link para redefinir a senha.");
  } catch (e) {
    console.error("Erro reset senha:", e);
    abrirModal("erro", "Erro", "N√£o foi poss√≠vel enviar o e-mail. Verifique o endere√ßo informado.");
  }
}

/* =========================
   PIX FLOW
========================= */
async function gerarPix(plan) {
  const user = auth.currentUser;
  if (!user) {
    show("loginBox");
    setMsg("Fa√ßa login.");
    return;
  }

  // UI
  if ($("qrBox")) $("qrBox").classList.remove("hide");
  if ($("payMsg")) $("payMsg").innerText = "";
  if ($("qrSub")) $("qrSub").innerText = "";

  updatePaymentStatus("processing", "Gerando PIX...");

  // desabilita bot√µes
  if ($("btnPlano6")) $("btnPlano6").disabled = true;
  if ($("btnPlano12")) $("btnPlano12").disabled = true;

  const btnId = plan === "6m" ? "btnPlano6" : "btnPlano12";
  setButtonLoading(btnId, true);

  try {
    const resp = await createPixChargeCall({ plan });
    const data = resp.data;

    debug("createPixCharge => " + JSON.stringify({ txid: data?.txid, plan: data?.plan, price: data?.price }));

    if (data?.alreadyEntitled) {
      abrirModal(
        "sucesso",
        "Acesso ativo",
        "Seu acesso premium j√° est√° ativo. Redirecionando para o app...",
        [{ text: "Ir para o app", primary: true, onclick: () => (window.location.href = FRONT_URL) }]
      );
      setTimeout(() => (window.location.href = FRONT_URL), 1500);
      return;
    }

    if (!data?.txid || !data?.qrcodeImage || !data?.copiaecola) {
      throw new Error("Resposta inv√°lida do servidor ao gerar PIX.");
    }

    currentTxid = data.txid;

    // mostra QR
    if ($("qrPlanInfo")) {
      $("qrPlanInfo").innerText = `Plano ${plan === "6m" ? "6 meses" : "1 ano"} ‚Äî R$ ${String(data.price).replace(".", ",")}`;
    }
    if ($("qrSub")) $("qrSub").innerText = "Escaneie o QR Code ou copie o c√≥digo";
    if ($("qrImg")) $("qrImg").src = "data:image/png;base64," + data.qrcodeImage;
    if ($("pixCopia")) $("pixCopia").value = data.copiaecola;

    updatePaymentStatus("pending", "Aguardando pagamento...");
    if ($("payMsg")) $("payMsg").innerHTML = "<span style='color:#64748b'>Escaneie com o app do seu banco ou cole o c√≥digo PIX.</span>";

    // countdown
    if (countdownInterval) clearInterval(countdownInterval);
    countdownInterval = startCountdown(data.expiresAt);

    // inicia polling
    iniciarPolling(data.txid);
  } catch (e) {
    console.error("ERRO gerarPix:", e);
    debug("Falha gerar PIX: " + (e?.message || "erro desconhecido"), true);

    let msg = "Erro ao gerar PIX. Tente novamente.";
    const code = e?.code || "";

    if (code === "functions/unauthenticated") {
      msg = "Sess√£o expirada. Fa√ßa login novamente.";
      show("loginBox");
    } else if (code === "functions/failed-precondition") {
      msg = e?.message || "Confirme seu e-mail antes de comprar.";
    } else if (code === "functions/invalid-argument") {
      msg = "Plano inv√°lido. Atualize a p√°gina.";
    } else if (code === "functions/internal") {
      msg = "Erro interno no servidor. Tente novamente em instantes.";
    }

    updatePaymentStatus("error", msg);
    if ($("payMsg")) $("payMsg").innerText = msg;
  } finally {
    // reabilita bot√µes
    if ($("btnPlano6")) $("btnPlano6").disabled = false;
    if ($("btnPlano12")) $("btnPlano12").disabled = false;
    setButtonLoading(btnId, false);
  }
}

function iniciarPolling(txid) {
  cancelarPolling();
  currentTxid = txid;

  // checa imediatamente
  verificarPagamento(txid);

  // intervalo
  pollingTimer = setInterval(() => verificarPagamento(txid), 5000);
}

async function verificarPagamento(txid) {
  if (!txid) return;

  try {
    const resp = await pixStatusCall({ txid });
    const data = resp.data;

    console.log("Status PIX:", data);

    if (data?.paid) {
      pagamentoConfirmado();
      return;
    }

    if (data?.expired) {
      updatePaymentStatus("error", "PIX expirado!");
      if ($("payMsg")) $("payMsg").innerText = "O prazo para pagamento expirou. Gere um novo PIX.";
      cancelarPolling();
      return;
    }

    if (data?.status) {
      updatePaymentStatus("pending", `Status: ${data.status}`);
    }

    retryCount = 0;
  } catch (e) {
    console.error("Erro ao verificar pagamento:", e);
    retryCount++;

    if (retryCount >= MAX_RETRIES) {
      updatePaymentStatus("error", "Erro ao verificar. Tente novamente.");
      if ($("payMsg")) $("payMsg").innerText = "Problema na conex√£o. Clique em 'Verificar pagamento'.";
      cancelarPolling();
    } else {
      updatePaymentStatus("processing", "Verificando...");
    }
  }
}

async function verificarPagamentoManual() {
  if (!currentTxid) {
    abrirModal("aviso", "Nenhum PIX", "Gere um PIX primeiro.");
    return;
  }
  updatePaymentStatus("processing", "Verificando...");
  retryCount = 0;
  await verificarPagamento(currentTxid);

  // se ainda existir txid e countdown ativo, mant√©m polling
  if (currentTxid && !pollingTimer) iniciarPolling(currentTxid);
}

function pagamentoConfirmado() {
  cancelarPolling();
  updatePaymentStatus("success", "Pagamento confirmado!");

  abrirModal(
    "sucesso",
    "üéâ Pagamento realizado!",
    "Seu acesso premium foi ativado com sucesso. Voc√™ pode acessar agora.",
    [
      { text: "Acessar o App", primary: true, onclick: () => (window.location.href = FRONT_URL) },
      { text: "Ver meu acesso", primary: false, onclick: () => carregarStatus() }
    ]
  );

  // limpa QR
  if ($("pixCopia")) $("pixCopia").value = "";
  if ($("qrImg")) $("qrImg").src = "";
  if ($("qrBox")) $("qrBox").classList.add("hide");
}

async function copiarPix() {
  const txt = $("pixCopia")?.value || "";
  if (!txt) return;

  try {
    await navigator.clipboard.writeText(txt);
    if ($("payMsg")) $("payMsg").innerHTML = "<span class='ok'>‚úÖ C√≥digo PIX copiado!</span>";
  } catch (e) {
    console.error("Falha clipboard:", e);

    // fallback
    const input = $("pixCopia");
    if (input) {
      input.focus();
      input.select();
      document.execCommand("copy");
      if ($("payMsg")) $("payMsg").innerHTML = "<span class='ok'>‚úÖ C√≥digo PIX copiado!</span>";
    }
  }
}

function cancelarPix() {
  cancelarPolling();
  if ($("qrBox")) $("qrBox").classList.add("hide");
  if ($("payMsg")) $("payMsg").innerText = "";
  if ($("qrSub")) $("qrSub").innerText = "";
  if ($("pixCopia")) $("pixCopia").value = "";
  if ($("qrImg")) $("qrImg").src = "";
  updatePaymentStatus("pending", "PIX cancelado.");
  abrirModal("info", "PIX cancelado", "Voc√™ pode gerar um novo PIX quando quiser.");
}

/* =========================
   EVENTS (bind once)
========================= */
function bindEventsOnce() {
  const btnEntrar = $("btnEntrar");
  const btnCriar = $("btnCriar");
  const btnResetSenha = $("btnResetSenha");
  const btnSair = $("btnSair");
  const btnTrocarConta = $("btnTrocarConta");
  const btnPlano6 = $("btnPlano6");
  const btnPlano12 = $("btnPlano12");
  const btnCopiar = $("btnCopiar");
  const btnCancelarPix = $("btnCancelarPix");
  const btnRecheck = $("btnRecheck");
  const btnAcessarApp = $("btnAcessarApp");

  if (btnEntrar) btnEntrar.addEventListener("click", entrar);
  if (btnCriar) btnCriar.addEventListener("click", criarConta);
  if (btnResetSenha) btnResetSenha.addEventListener("click", recuperarSenha);

  if (btnSair) btnSair.addEventListener("click", sair);
  if (btnTrocarConta) btnTrocarConta.addEventListener("click", sair);

  if (btnPlano6) btnPlano6.addEventListener("click", () => gerarPix("6m"));
  if (btnPlano12) btnPlano12.addEventListener("click", () => gerarPix("12m"));

  if (btnCopiar) btnCopiar.addEventListener("click", copiarPix);
  if (btnCancelarPix) btnCancelarPix.addEventListener("click", cancelarPix);
  if (btnRecheck) btnRecheck.addEventListener("click", verificarPagamentoManual);

  if (btnAcessarApp) {
    btnAcessarApp.addEventListener("click", () => {
      window.location.href = FRONT_URL;
    });
  }

  // toggle senha
  const toggleSenha = $("toggleSenha");
  const senhaInput = $("senha");
  if (toggleSenha && senhaInput) {
    toggleSenha.addEventListener("click", () => {
      const isPassword = senhaInput.type === "password";
      senhaInput.type = isPassword ? "text" : "password";
      toggleSenha.innerText = isPassword ? "üôà" : "üëÅÔ∏è";
    });
  }
}

bindEventsOnce();

/* =========================
   AUTH STATE
========================= */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    debug("Usu√°rio deslogado. Aguardando login...");
    show("loginBox");
    return;
  }
  debug("Usu√°rio logado. Carregando status...");
  await carregarStatus();
});

/* =========================
   START STATE
========================= */
show("loginBox");
debug("P√°gina carregada. Ready!");
</script>

</body>
</html>



