<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Simulados de Concursos</title>

<style>
:root{
--primary:#2563eb;
--primary-dark:#1e40af;
--bg1:#0b1220;
--bg2:#0f172a;
--card:#ffffff;
--text:#0f172a;
--muted:#64748b;
--border:#e2e8f0;
--success:#16a34a;
--warning:#f59e0b;
--danger:#dc2626;
--shadow: 0 40px 90px rgba(0,0,0,.40);
--radius:22px;
}

*{box-sizing:border-box}
html,body{height:100%}

body{
margin:0;
font-family: Inter, system-ui, -apple-system, Arial, sans-serif;
color:#fff;
background:
radial-gradient(1200px 800px at 20% 20%, rgba(37,99,235,.22), transparent 60%),
radial-gradient(900px 700px at 80% 30%, rgba(16,185,129,.18), transparent 60%),
linear-gradient(rgba(11,18,32,.78), rgba(15,23,42,.78)),
url("https://images.pexels.com/photos/990432/pexels-photo-990432.jpeg");
background-size:cover;
background-position:center;
background-attachment:fixed;
}

.page{
min-height:100%;
display:flex;
align-items:center;
justify-content:center;
padding:28px;
}

.container{
width:100%;
max-width:1180px;
display:grid;
grid-template-columns: 1.15fr 1fr;
gap:44px;
align-items:start;
}

@media (max-width: 980px){
.container{grid-template-columns:1fr; gap:22px}
.page{padding:18px}
}

/* HERO */
.hero{
padding:8px 6px;
}
.hero h1{
font-size:42px;
margin:0 0 14px;
line-height:1.06;
letter-spacing:-.02em;
}
.hero p{
font-size:18px;
margin:0 0 18px;
color:#e5e7eb;
max-width:46ch;
}
.hero ul{
list-style:none;
padding:0;
margin:0;
display:grid;
gap:10px;
}
.hero li{
color:#f1f5f9;
display:flex;
gap:10px;
align-items:flex-start;
}
.hero li::before{
content:"‚úì";
display:inline-flex;
align-items:center;
justify-content:center;
width:22px;
height:22px;
border-radius:999px;
background:rgba(34,197,94,.18);
color:#22c55e;
font-weight:900;
margin-top:1px;
flex:0 0 22px;
}

.brand-chip{
display:inline-flex;
align-items:center;
gap:10px;
padding:10px 14px;
border:1px solid rgba(226,232,240,.22);
border-radius:999px;
background:rgba(15,23,42,.35);
backdrop-filter: blur(10px);
margin-bottom:14px;
}
.brand-dot{
width:10px;height:10px;border-radius:999px;
background:linear-gradient(135deg, #60a5fa, #2563eb);
box-shadow:0 0 0 4px rgba(37,99,235,.18);
}
.brand-chip span{color:#e5e7eb;font-size:13px}

/* RIGHT COLUMN */
.stack{
display:grid;
gap:14px;
}

/* CARD */
.card{
background:var(--card);
color:var(--text);
border-radius:var(--radius);
box-shadow:var(--shadow);
border:1px solid rgba(226,232,240,.85);
overflow:hidden;
}

.card-header{
padding:18px 20px;
border-bottom:1px solid var(--border);
background:linear-gradient(180deg, rgba(37,99,235,.08), rgba(255,255,255,0));
}
.card-title{
margin:0;
font-size:16px;
font-weight:900;
letter-spacing:-.01em;
}
.card-sub{
margin:6px 0 0;
font-size:13px;
color:var(--muted);
line-height:1.35;
}
.card-body{
padding:18px 20px 20px;
}

.hr{height:1px;background:var(--border);margin:16px 0}
.small{font-size:13px;color:var(--muted);line-height:1.35}

label{
display:block;
font-size:13px;
color:#475569;
margin-bottom:6px;
font-weight:700;
}
.field{
margin-bottom:12px;
}
input{
width:100%;
padding:13px 14px;
border-radius:14px;
border:1px solid var(--border);
font-size:15px;
background:#fff;
color:var(--text);
outline:none;
}
input:focus{
border-color:#93c5fd;
box-shadow:0 0 0 4px rgba(59,130,246,.15);
}

.row{
display:flex;
gap:10px;
}
.row > *{flex:1}

/* BUTTONS */
button{
width:100%;
padding:13px 14px;
border-radius:14px;
border:0;
font-size:15px;
cursor:pointer;
transition:transform .05s ease, background .15s ease, opacity .15s ease;
font-weight:800;
}
button:active{transform:translateY(1px)}
button:disabled{opacity:.65; cursor:not-allowed}

.btn-primary{
background:linear-gradient(135deg, #2563eb, #1d4ed8);
color:#fff;
}
.btn-primary:hover{
background:linear-gradient(135deg, #1d4ed8, #1e40af);
}
.btn-sec{
background:#f1f5f9;
color:#0f172a;
}
.btn-sec:hover{background:#e2e8f0}

.link-row{
display:flex;
justify-content:space-between;
gap:10px;
margin-top:10px;
}
.link{
background:transparent;
border:0;
padding:0;
width:auto;
color:#2563eb;
font-weight:800;
cursor:pointer;
font-size:13px;
}
.link:hover{text-decoration:underline}

.msg{
margin-top:12px;
font-size:13px;
text-align:center;
color:var(--danger);
font-weight:700;
}
.msg-success{
margin-top:12px;
font-size:13px;
text-align:center;
color:var(--success);
font-weight:700;
}

.hide{display:none!important; pointer-events:none!important}

.password-wrap{position:relative}
.password-toggle{
position:absolute;
right:14px;
top:50%;
transform:translateY(-50%);
cursor:pointer;
font-size:18px;
opacity:.65;
user-select:none;
}

/* STATUS BOX */
.status-box{
border:1px solid var(--border);
border-radius:16px;
padding:14px;
background:#fff;
}
.status-box.trial{
background: linear-gradient(135deg, #fefce8, #fef9c3);
border-color:#fde047;
}
.status-box.premium{
background: linear-gradient(135deg, #f0f9ff, #bae6fd);
border-color:#7dd3fc;
}
.status-title{
font-weight:900;
font-size:16px;
margin-bottom:6px;
}

/* PLANS */
.plan-grid{
display:grid;
gap:12px;
margin-top:10px;
}
.plan{
border:1px solid var(--border);
border-radius:16px;
padding:14px;
background:#fff;
}
.plan.reco{
border:2px solid var(--primary);
box-shadow:0 12px 28px rgba(37,99,235,.14);
}
.plan-top{
display:flex;
justify-content:space-between;
align-items:center;
gap:10px;
}
.badge{
background:#e0e7ff;
color:#1e40af;
padding:6px 10px;
border-radius:999px;
font-size:12px;
font-weight:900;
}
.price{
font-size:22px;
font-weight:900;
color:#0f172a;
margin:8px 0 0;
}

/* PAYMENT / QR PANEL (√ÅREA EXCLUSIVA) */
.qr-panel{
margin-top:14px;
border:1px solid var(--border);
border-radius:18px;
background:linear-gradient(180deg, rgba(2,6,23,.03), rgba(2,6,23,0));
padding:14px;
}
.payment-status{
display:flex;
align-items:center;
justify-content:center;
gap:8px;
padding:11px;
border-radius:12px;
font-weight:900;
font-size:13px;
}
.payment-status.pending{background:#fef3c7;color:#92400e}
.payment-status.processing{background:#dbeafe;color:#1e40af}
.payment-status.success{background:#dcfce7;color:#166534}
.payment-status.error{background:#fee2e2;color:#991b1b}

.qrImg{
width:100%;
max-width:260px;
border:1px solid var(--border);
border-radius:14px;
padding:10px;
background:#fff;
display:block;
margin:12px auto 0;
}

.pix-timer{
display:flex;
align-items:center;
justify-content:center;
gap:6px;
font-size:13px;
color:#64748b;
margin-top:10px;
}
.pix-timer span{font-weight:900;color:#0f172a}

.copyRow{
display:flex;
gap:8px;
margin-top:10px;
}
.copyRow input{margin:0;flex:1}
.copyRow button{
width:auto;
padding:12px 14px;
border-radius:14px;
background:#0f172a;
color:#fff;
}

/* MODAL (global) */
.modal-overlay{
position:fixed;
inset:0;
background:rgba(15,23,42,.75);
display:flex;
align-items:center;
justify-content:center;
z-index:9999;
padding:18px;
}
.modal{
width:100%;
max-width:520px;
background:#fff;
color:#0f172a;
border-radius:22px;
box-shadow:0 50px 110px rgba(0,0,0,.45);
overflow:hidden;
border:1px solid rgba(226,232,240,.9);
}
.modal-head{
padding:16px 18px;
border-bottom:1px solid var(--border);
background:linear-gradient(180deg, rgba(37,99,235,.08), rgba(255,255,255,0));
display:flex;
align-items:center;
justify-content:space-between;
gap:10px;
}
.modal-title{
margin:0;
font-size:15px;
font-weight:900;
}
.modal-close{
width:auto;
padding:8px 10px;
border-radius:12px;
background:#f1f5f9;
color:#0f172a;
font-size:13px;
font-weight:900;
}
.modal-body{padding:16px 18px 18px}
.modal-actions{display:flex; gap:10px; margin-top:12px}
.modal-actions > *{flex:1}

/* Loading spinner */
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.loading-spinner{
width:18px;height:18px;
border:2px solid transparent;
border-top-color:currentColor;
border-radius:50%;
display:inline-block;
animation:spin .8s linear infinite;
vertical-align:middle;
margin-right:8px;
}
</style>
</head>

<body>

<!-- MODAL: CRIAR CONTA (CAIXA EXCLUSIVA) -->
<div id="signupOverlay" class="modal-overlay hide">
<div class="modal" role="dialog" aria-modal="true" aria-labelledby="signupTitle">
<div class="modal-head">
<h3 id="signupTitle" class="modal-title">Criar conta gratuita</h3>
<button id="btnCloseSignup" class="modal-close" type="button">Fechar</button>
</div>
<div class="modal-body">
<div class="small" style="margin-bottom:12px">
Crie sua conta e confirme o e-mail. O trial de 48h √© liberado ap√≥s o e-mail confirmado (controle no backend).
</div>

<div class="field">
<label for="signupEmail">E-mail</label>
<input id="signupEmail" type="email" placeholder="seu@email.com" autocomplete="email">
</div>

<div class="row">
<div class="field">
<label for="signupPass">Senha</label>
<input id="signupPass" type="password" placeholder="m√≠n. 6 caracteres" autocomplete="new-password">
</div>
<div class="field">
<label for="signupPass2">Confirmar senha</label>
<input id="signupPass2" type="password" placeholder="repita a senha" autocomplete="new-password">
</div>
</div>

<div id="signupMsg" class="msg hide"></div>

<div class="modal-actions">
<button id="btnSignupCreate" class="btn-primary" type="button">Criar conta</button>
<button id="btnSignupCancel" class="btn-sec" type="button">Cancelar</button>
</div>
</div>
</div>
</div>

<!-- MODAL: MENSAGENS -->
<div id="modalOverlay" class="modal-overlay hide">
<div class="modal" role="dialog" aria-modal="true">
<div class="modal-head">
<h3 id="modalTitle" class="modal-title">Aviso</h3>
<button id="btnCloseModal" class="modal-close" type="button">Fechar</button>
</div>
<div class="modal-body">
<div id="modalMessage" class="small" style="color:#334155"></div>
<div style="margin-top:14px">
<button id="btnModalOk" class="btn-primary" type="button">OK</button>
</div>
</div>
</div>
</div>

<div class="page">
<div class="container">

<!-- HERO -->
<div class="hero">
<div class="brand-chip">
<div class="brand-dot"></div>
<span>Plataforma de simulados ‚Äî acesso por trial e premium via PIX</span>
</div>

<h1>Prepare-se para concursos<br>com foco total em aprova√ß√£o</h1>
<p>Simulados atualizados, estudo direto ao ponto e acesso imediato. Seu acesso √© validado no backend.</p>
<ul>
<li>Quest√µes comentadas</li>
<li>Simulados realistas</li>
<li>Conte√∫do focado em prova</li>
<li>Teste gratuito por 48 horas</li>
</ul>
</div>

<!-- RIGHT: STACK -->
<div class="stack">

<!-- LOGIN CARD (CAIXA BONITA) -->
<div class="card" id="loginCard">
<div class="card-header">
<h2 class="card-title">Acesso √† plataforma</h2>
<p class="card-sub">Entre com sua conta. O status (trial/premium) vem do backend.</p>
</div>
<div class="card-body">

<div id="loginBox">
<div class="field">
<label for="email">E-mail</label>
<input id="email" type="email" placeholder="seu@email.com" autocomplete="email">
</div>

<div class="field">
<label for="senha">Senha</label>
<div class="password-wrap">
<input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="padding-right:46px" autocomplete="current-password">
<span id="toggleSenha" class="password-toggle" title="Mostrar/ocultar senha">üëÅÔ∏è</span>
</div>
</div>

<button class="btn-primary" id="btnEntrar" type="button">Entrar</button>

<div class="link-row">
<button class="link" id="btnOpenSignup" type="button">Criar conta</button>
<button class="link" id="btnResetSenha" type="button">Esqueci a senha</button>
</div>

<div id="msgLogin" class="msg"></div>
</div>

<!-- STATUS CARD AREA -->
<div id="statusBox" class="hide">
<div class="hr"></div>

<div id="statusInfoBox" class="status-box">
<div id="statusText" class="status-title"></div>
<div id="statusSub" class="small"></div>
</div>

<div class="row" style="margin-top:12px">
<button class="btn-primary" id="btnAcessarApp" type="button">üöÄ Acessar o App</button>
<button class="btn-sec" id="btnSair" type="button">Sair</button>
</div>
</div>

</div>
</div>

<!-- PAYMENT CARD (CAIXA PR√ìPRIA E PROFISSIONAL) -->
<div class="card hide" id="payCard">
<div class="card-header">
<h2 class="card-title">Assinatura e pagamento</h2>
<p class="card-sub">Escolha um plano. Ao gerar, o QR Code aparece em uma √°rea exclusiva.</p>
</div>
<div class="card-body">
<div style="background:#fef3c7;border:1px solid #fde047;border-radius:16px;padding:14px;margin-bottom:14px">
<div style="font-weight:900;color:#92400e">‚ö†Ô∏è Seu acesso n√£o est√° ativo</div>
<div class="small" style="color:#78350f;margin-top:4px">Renove para continuar estudando sem interrup√ß√µes.</div>
</div>

<button class="btn-sec" id="btnTrocarConta" type="button" style="margin-bottom:10px">üîÑ Trocar conta</button>

<div class="small">Escolha um plano:</div>
<div class="plan-grid">
<div class="plan reco">
<div class="plan-top">
<div style="font-weight:900">Plano 6 meses</div>
<span class="badge">Recomendado</span>
</div>
<div class="price">R$ 29,90</div>
<div class="small">Acesso completo por 6 meses.</div>
<button class="btn-primary" id="btnPlano6" type="button" style="margin-top:10px">Gerar PIX (6 meses)</button>
</div>

<div class="plan">
<div class="plan-top">
<div style="font-weight:900">Plano 1 ano</div>
<span class="badge">Economia</span>
</div>
<div class="price">R$ 49,90</div>
<div class="small">Acesso completo por 12 meses.</div>
<button class="btn-primary" id="btnPlano12" type="button" style="margin-top:10px">Gerar PIX (1 ano)</button>
</div>
</div>

<!-- QR EXCLUSIVO -->
<div id="qrBox" class="qr-panel hide">
<div id="paymentStatusBox" class="payment-status pending">
<span id="paymentStatusIcon">‚è≥</span>
<span id="paymentStatusText">Aguardando pagamento...</span>
</div>

<div style="text-align:center;margin-top:12px">
<div style="font-weight:900" id="qrPlanInfo"></div>
<div class="small" id="qrSub" style="margin-top:4px"></div>
</div>

<img id="qrImg" class="qrImg" alt="QR Code PIX">

<div class="pix-timer" id="pixTimer">
‚è∞ Expira em: <span id="countdown">--:--</span>
</div>

<div class="copyRow">
<input id="pixCopia" readonly>
<button id="btnCopiar" type="button">üìã Copiar</button>
</div>

<div id="payMsg" class="small" style="margin-top:12px;text-align:center"></div>

<div class="row" style="margin-top:14px">
<button class="btn-sec" id="btnCancelarPix" type="button">Cancelar</button>
<button class="btn-primary" id="btnRecheck" type="button">üîÑ Verificar pagamento</button>
</div>
</div>

</div>
</div>

</div>
</div>
</div>

<script type="module">
/* =========================
 FIREBASE IMPORTS
========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
getAuth,
setPersistence,
browserLocalPersistence,
signInWithEmailAndPassword,
createUserWithEmailAndPassword,
signOut,
sendEmailVerification,
sendPasswordResetEmail,
onAuthStateChanged,
onIdTokenChanged
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-functions.js";

/* =========================
 CONFIG (SEU PROJETO)
========================= */
const FRONT_URL = "https://megaestudos.github.io/Quiz-Guarda-Civil-Premium/";
const firebaseConfig = {
apiKey: "AIzaSyB36ZszS8v_DeOn3at7zEo_tFq86WU0sI4",
authDomain: "simulados-concursos-22c91.firebaseapp.com",
projectId: "simulados-concursos-22c91"
};
const FUNCTIONS_REGION = "us-central1";

/* =========================
 INIT
========================= */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const fx = getFunctions(app, FUNCTIONS_REGION);

// Persist√™ncia local (mant√©m login)
try {
await setPersistence(auth, browserLocalPersistence);
} catch (e) {
console.warn("Persist√™ncia n√£o aplicada (seguindo padr√£o):", e);
}

/* =========================
 CALLABLE FUNCTIONS
========================= */
const meFunc = httpsCallable(fx, "me");
const createPixChargeFunc = httpsCallable(fx, "createPixCharge");
const pixStatusFunc = httpsCallable(fx, "pixStatus");

/* =========================
 HELPERS
========================= */
const $ = (id) => document.getElementById(id);

function showOnly(section){
// sections: loginBox/statusBox/payCard
const loginBox = $("loginBox");
const statusBox = $("statusBox");
const payCard  = $("payCard");

if (loginBox) loginBox.classList.toggle("hide", section !== "login");
if (statusBox) statusBox.classList.toggle("hide", section !== "status");
if (payCard) payCard.classList.toggle("hide", section !== "pay");
}

function setMsg(t){
const el = $("msgLogin");
if (el) el.innerText = t || "";
}

function setButtonLoading(buttonId, loading){
const btn = $(buttonId);
if (!btn) return;
btn.disabled = !!loading;
if (loading){
btn.dataset.originalText = btn.innerText;
btn.innerHTML = `<span class="loading-spinner"></span>Carregando...`;
} else {
btn.innerText = btn.dataset.originalText || btn.innerText || "OK";
}
}

function openModal(title, message){
const overlay = $("modalOverlay");
const t = $("modalTitle");
const m = $("modalMessage");
if (!overlay || !t || !m) return;
t.innerText = title || "Aviso";
m.innerText = message || "";
overlay.classList.remove("hide");
}
function closeModal(){
const overlay = $("modalOverlay");
if (overlay) overlay.classList.add("hide");
}

/* Signup modal */
function openSignup(){
$("signupOverlay")?.classList.remove("hide");
$("signupMsg")?.classList.add("hide");
if ($("signupMsg")) $("signupMsg").innerText = "";
$("signupEmail")?.focus();
}
function closeSignup(){
$("signupOverlay")?.classList.add("hide");
if ($("signupEmail")) $("signupEmail").value = "";
if ($("signupPass")) $("signupPass").value = "";
if ($("signupPass2")) $("signupPass2").value = "";
if ($("signupMsg")) { $("signupMsg").innerText = ""; $("signupMsg").classList.add("hide"); }
}
function setSignupMsg(text){
const el = $("signupMsg");
if (!el) return;
el.innerText = text || "";
el.classList.toggle("hide", !text);
}

/* =========================
 TOKEN/SESSION SAFE CALL
 (reduz chance de 401 em edge cases)
========================= */
async function callMeSafe() {
 callMeSafe() {
try {
return await meFunc();
} catch (e) {
const code = e?.code || "";

// Se deu unauthenticated mas h√° usu√°rio, for√ßa refresh e tenta novamente
if (code === "functions/unauthenticated" && auth.currentUser) {
await auth.currentUser.getIdToken(true);
await new Promise(r => setTimeout(r, 600));
return await meFunc();
}
throw e;
}
}

  async function checkPremiumSafe() {
  const user = auth.currentUser;
  if (!user) return { premium: false };

  const token = await user.getIdToken(true);

  const resp = await fetch(
    "https://us-central1-simulados-concursos-22c91.cloudfunctions.net/checkPremium",
    {
      method: "GET",
      headers: {
        "Authorization": "Bearer " + token
      }
    }
  );

  return await resp.json();
}

/* =========================
 STATUS & ACCESS (backend manda)
========================= */
async function carregarStatus(){

// üîí Nunca chama backend sem usu√°rio
if (!auth.currentUser) {
console.log("[STATUS] Nenhum usu√°rio logado");
showOnly("login");
return;
}

// üîí Garante token v√°lido
try {
await auth.currentUser.getIdToken(true);
} catch (err) {
console.warn("[STATUS] Token indispon√≠vel", err);
showOnly("login");
return;
}

try {
const result = await callMeSafe();
const data = result.data || {};

if (data.authenticated !== true){
showOnly("login");
setMsg("Sess√£o inv√°lida. Fa√ßa login novamente.");
return;
}

if (data.emailVerified === false){
showOnly("login");
setMsg("Confirme seu e-mail para liberar o acesso.");
openModal(
"Confirme seu e-mail",
"Verifique sua caixa de entrada e o spam para confirmar o e-mail."
);
return;
}

// Sem acesso ‚Üí pagamento
if (!data.entitled){
showOnly("pay");
hideQrArea();
return;
}

// Acesso ativo
const statusBox = $("statusInfoBox");
const statusText = $("statusText");
const statusSub = $("statusSub");

if (statusBox){
statusBox.className = "status-box " + (data.plan || "");
}

if (data.plan === "trial"){
statusText.innerText = "üéì Teste gr√°tis ativo";
const exp = new Date(data.expiresAt);
statusSub.innerText = `V√°lido at√©: ${exp.toLocaleString("pt-BR")}`;
}
else if (data.plan === "premium"){
statusText.innerText = "‚≠ê Acesso Premium ativo";
const exp = new Date(data.expiresAt);
statusSub.innerText = `V√°lido at√©: ${exp.toLocaleString("pt-BR")}`;
}

showOnly("status");

} catch (err) {
console.error("Erro ao carregar status:", err);
showOnly("login");
setMsg("Erro ao validar sess√£o. Fa√ßa login novamente.");
}
}

/* =========================
 AUTH
========================= */
async function entrar() {
setMsg("");

const emailEl = $("email");
const senhaEl = $("senha");

const email = emailEl?.value.trim();
const senha = senhaEl?.value;

if (!email || !senha) {
setMsg("Preencha e-mail e senha.");
return;
}

try {
const cred = await signInWithEmailAndPassword(auth, email, senha);

// for√ßa gera√ß√£o do ID TOKEN
await cred.user.getIdToken(true);

// pequeno delay real (evita race condition)
await new Promise(r => setTimeout(r, 500));

// chama backend
const result = await meFunc();
const data = result.data;

if (!data.entitled) {
showOnly("pay");
return;
}

// acesso liberado
window.location.href = FRONT_URL;

} catch (err) {
console.error(err);
setMsg("Login inv√°lido.");
}
}

async function criarContaModal(){
setSignupMsg("");

const email = ($("signupEmail")?.value || "").trim();
const p1 = $("signupPass")?.value || "";
const p2 = $("signupPass2")?.value || "";

if (!email || !p1 || !p2){
setSignupMsg("Preencha e-mail e senha.");
return;
}
if (p1.length < 6){
setSignupMsg("A senha deve ter pelo menos 6 caracteres.");
return;
}
if (p1 !== p2){
setSignupMsg("As senhas n√£o conferem.");
return;
}

setButtonLoading("btnSignupCreate", true);
try {
const cred = await createUserWithEmailAndPassword(auth, email, p1);
await sendEmailVerification(cred.user);
closeSignup();
openModal("Conta criada", "Enviamos um e-mail de verifica√ß√£o. Confirme para liberar o acesso e a compra.");
setMsg("Conta criada. Confirme seu e-mail antes de continuar.");
// Mant√©m no login
showOnly("login");
// limpa campos login e preenche email para facilitar
if ($("email")) $("email").value = email;
if ($("senha")) $("senha").value = "";
} catch (e) {
console.error("Erro criar conta:", e);
setSignupMsg(e?.message || "N√£o foi poss√≠vel criar a conta.");
} finally {
setButtonLoading("btnSignupCreate", false);
}
}

async function recuperarSenha(){
const email = ($("email")?.value || "").trim();
if (!email){
openModal("E-mail obrigat√≥rio", "Digite seu e-mail para receber o link de redefini√ß√£o.");
return;
}
try {
await sendPasswordResetEmail(auth, email);
openModal("E-mail enviado", "Se este e-mail estiver cadastrado, voc√™ receber√° um link para redefinir a senha.");
} catch (e) {
console.error("Reset senha:", e);
openModal("Erro", "N√£o foi poss√≠vel enviar o e-mail. Verifique o endere√ßo informado.");
}
}

async function sair(){
try { await signOut(auth); } catch(_){}
// limpa UI
if ($("email")) $("email").value = "";
if ($("senha")) $("senha").value = "";
setMsg("");
hideQrArea();
cancelarPolling();
showOnly("login");
}

/* =========================
 PAYMENT / PIX
========================= */
let pollingTimer = null;
let countdownInterval = null;
let currentTxid = null;
let retryCount = 0;
const MAX_RETRIES = 3;

function cancelarPolling(){
if (pollingTimer){ clearInterval(pollingTimer); pollingTimer = null; }
if (countdownInterval){ clearInterval(countdownInterval); countdownInterval = null; }
}

function hideQrArea(){
if ($("qrBox")) $("qrBox").classList.add("hide");
if ($("qrImg")) $("qrImg").src = "";
if ($("pixCopia")) $("pixCopia").value = "";
if ($("qrSub")) $("qrSub").innerText = "";
if ($("qrPlanInfo")) $("qrPlanInfo").innerText = "";
if ($("payMsg")) $("payMsg").innerText = "";
if ($("countdown")) $("countdown").innerText = "--:--";
if ($("pixTimer")) $("pixTimer").style.display = "flex";
currentTxid = null;
retryCount = 0;
}

function updatePaymentStatus(status, text){
const box = $("paymentStatusBox");
const icon = $("paymentStatusIcon");
const msg  = $("paymentStatusText");
if (!box) return;

box.className = "payment-status " + (status || "pending");
const map = {
pending:   { i:"‚è≥", t: text || "Aguardando pagamento..." },
processing:{ i:"üîÑ", t: text || "Processando..." },
success:   { i:"‚úÖ", t: text || "Pagamento confirmado!" },
error:     { i:"‚ùå", t: text || "Falha no pagamento." }
};
const s = map[status] || map.pending;
if (icon) icon.innerText = s.i;
if (msg)  msg.innerText  = s.t;
}

function startCountdown(expiresAtIso){
const timer = $("pixTimer");
const countdown = $("countdown");
if (!timer || !countdown) return;

if (!expiresAtIso){
timer.style.display = "none";
return;
}
timer.style.display = "flex";

const expires = new Date(expiresAtIso).getTime();
if (countdownInterval) clearInterval(countdownInterval);

const tick = () => {
const diff = expires - Date.now();
if (diff <= 0){
countdown.innerText = "00:00";
updatePaymentStatus("error", "PIX expirado! Gere um novo.");
cancelarPolling();
return;
}
const mins = Math.floor(diff / 60000);
const secs = Math.floor((diff % 60000) / 1000);
countdown.innerText = `${String(mins).padStart(2,"0")}:${String(secs).padStart(2,"0")}`;
};

tick();
countdownInterval = setInterval(tick, 1000);
}

async function gerarPix(plan){
if (!auth.currentUser){
showOnly("login");
setMsg("Fa√ßa login.");
return;
}

const btnId = plan === "6m" ? "btnPlano6" : "btnPlano12";
setButtonLoading(btnId, true);

try {
// Mostra √°rea exclusiva do QR
if ($("qrBox")) $("qrBox").classList.remove("hide");
updatePaymentStatus("processing", "Gerando PIX...");

const resp = await createPixChargeFunc({ plan });
const data = resp.data || {};

if (data.alreadyEntitled){
openModal("Acesso ativo", "Seu acesso premium j√° est√° ativo.");
await carregarStatus();
return;
}

if (!data.txid || !data.qrcodeImage || !data.copiaecola){
throw new Error("Resposta inv√°lida ao gerar PIX.");
}

currentTxid = data.txid;

// IMPORTANTE: backend retorna base64 (imagemQrcode). Precisa do prefixo.
if ($("qrImg")) $("qrImg").src = "data:image/png;base64," + data.qrcodeImage;

if ($("pixCopia")) $("pixCopia").value = data.copiaecola;

if ($("qrPlanInfo")){
$("qrPlanInfo").innerText = (plan === "6m")
? "Plano 6 meses ‚Äî R$ 29,90"
: "Plano 1 ano ‚Äî R$ 49,90";
}

if ($("qrSub")) $("qrSub").innerText = "Escaneie o QR Code ou copie o c√≥digo PIX.";

updatePaymentStatus("pending", "Aguardando pagamento...");
startCountdown(data.expiresAt);

retryCount = 0;
cancelarPolling();
// checa imediatamente e depois a cada 5s
await verificarPagamento(currentTxid);
pollingTimer = setInterval(() => verificarPagamento(currentTxid), 5000);

} catch (e) {
console.error("Erro gerarPix:", e);
const code = e?.code || "";
if (code === "functions/unauthenticated"){
showOnly("login");
setMsg("Sess√£o expirada. Fa√ßa login novamente.");
return;
}
updatePaymentStatus("error", "Erro ao gerar PIX.");
if ($("payMsg")) $("payMsg").innerText = (e?.message || "N√£o foi poss√≠vel gerar o PIX.");
} finally {
setButtonLoading(btnId, false);
}
}

async function verificarPagamento(txid){
if (!txid) return;

try {
const resp = await pixStatusFunc({ txid });
const data = resp.data || {};

if (data.paid){
updatePaymentStatus("success", "Pagamento confirmado!");
cancelarPolling();
openModal("Pagamento recebido", "Seu acesso foi ativado. Voc√™ j√° pode acessar o app.");
// atualiza status do backend
await carregarStatus();
// fecha √°rea QR
hideQrArea();
return;
}

if (data.expired){
updatePaymentStatus("error", "PIX expirado!");
cancelarPolling();
return;
}

if (data.status){
updatePaymentStatus("pending", `Status: ${data.status}`);
}
retryCount = 0;
} catch (e) {
console.error("Erro verificar pagamento:", e);
retryCount++;

if (retryCount >= MAX_RETRIES){
updatePaymentStatus("error", "Erro ao verificar. Tente novamente.");
cancelarPolling();
} else {
updatePaymentStatus("processing", "Verificando...");
}
}
}

async function verificarPagamentoManual(){
if (!currentTxid){
openModal("Nenhum PIX", "Gere um PIX primeiro.");
return;
}
setButtonLoading("btnRecheck", true);
try{
updatePaymentStatus("processing", "Verificando...");
await verificarPagamento(currentTxid);
// se n√£o pagou e n√£o expirou, volta o polling
if (currentTxid && !pollingTimer){
pollingTimer = setInterval(() => verificarPagamento(currentTxid), 5000);
}
} finally {
setButtonLoading("btnRecheck", false);
}
}

async function copiarPix(){
const txt = $("pixCopia")?.value || "";
if (!txt) return;

try {
await navigator.clipboard.writeText(txt);
if ($("payMsg")) $("payMsg").innerText = "‚úÖ C√≥digo PIX copiado!";
} catch (e) {
// fallback
const input = $("pixCopia");
if (input){
input.focus();
input.select();
document.execCommand("copy");
if ($("payMsg")) $("payMsg").innerText = "‚úÖ C√≥digo PIX copiado!";
}
}
}

function cancelarPix(){
cancelarPolling();
hideQrArea();
updatePaymentStatus("pending", "PIX cancelado.");
openModal("PIX cancelado", "Voc√™ pode gerar um novo PIX quando quiser.");
}

/* =========================
 EVENTS
========================= */
function on(id, evt, handler){
const el = $(id);
if (!el) return;
el.addEventListener(evt, handler);
}

on("btnEntrar", "click", entrar);
on("btnOpenSignup", "click", openSignup);
on("btnResetSenha", "click", recuperarSenha);

on("btnCloseSignup", "click", closeSignup);
on("btnSignupCancel", "click", closeSignup);
on("btnSignupCreate", "click", criarContaModal);

on("btnCloseModal", "click", closeModal);
on("btnModalOk", "click", closeModal);
on("modalOverlay", "click", (e)=>{ if (e.target?.id === "modalOverlay") closeModal(); });
on("signupOverlay", "click", (e)=>{ if (e.target?.id === "signupOverlay") closeSignup(); });

on("btnSair", "click", sair);
on("btnTrocarConta", "click", sair);

on("btnPlano6", "click", () => gerarPix("6m"));
on("btnPlano12", "click", () => gerarPix("12m"));

on("btnCopiar", "click", copiarPix);
on("btnCancelarPix", "click", cancelarPix);
on("btnRecheck", "click", verificarPagamentoManual);

on("btnAcessarApp", "click", () => window.location.href = FRONT_URL);

on("toggleSenha", "click", () => {
const input = $("senha");
if (!input) return;
const isPwd = input.type === "password";
input.type = isPwd ? "text" : "password";
const t = $("toggleSenha");
if (t) t.innerText = isPwd ? "üôà" : "üëÅÔ∏è";
});

/* =========================
 AUTH STATE
 - N√ÉO chama backend no boot
========================= */

onAuthStateChanged(auth, (user) => {
if (user) {
console.log("[AUTH] Usu√°rio detectado:", user.uid);
// N√ÉO chama me() aqui
} else {
showOnly("login");
}
});

// Opcional: mant√©m o onAuthStateChanged apenas para debug (sem chamar backend)
onAuthStateChanged(auth, (user) => {
if (user) console.log("[AUTH] Usu√°rio detectado:", user.uid);
});

/* =========================
 INIT
========================= */
showOnly("login");
</script>

</body>
</html>








