<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getAuth,
  setPersistence,
  browserSessionPersistence,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-functions.js";

/* ===== CONFIG ===== */
const FRONT_URL = "https://megaestudos.github.io/Quiz-Guarda-Civil-Premium/";
const firebaseConfig = {
  apiKey: "AIzaSyB36ZszS8v_DeOn3at7zEo_tFq86WU0sI4",
  authDomain: "simulados-concursos-22c91.firebaseapp.com",
  projectId: "simulados-concursos-22c91"
};

/* ===== INIT ===== */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// DEFINA A PERSISTÊNCIA UMA ÚNICA VEZ (sem duplicar)
try {
  await setPersistence(auth, browserSessionPersistence);
} catch (err) {
  console.error("Erro setPersistence:", err);
}

const functions = getFunctions(app, "us-central1");
const meCall = httpsCallable(functions, "me");
const createPixChargeCall = httpsCallable(functions, "createPixCharge");
const pixStatusCall = httpsCallable(functions, "pixStatus");

/* ===== UI HELPERS ===== */
const $ = (id)=>document.getElementById(id);
const show = (boxId)=>{
  ["loginBox","statusBox","payBox"].forEach(x=>$(x).classList.toggle("hide", x!==boxId));
};
function setMsg(t){ $("msgLogin").innerText = t || ""; }

/* ===== EVENTS ===== */
$("btnEntrar").addEventListener("click", entrar);
$("btnCriar").addEventListener("click", criarConta);

$("btnSair").addEventListener("click", async ()=>{
  await signOut(auth);
  $("qrBox").classList.add("hide");
  $("payMsg").innerText = "";
  $("qrSub").innerText = "";
  show("loginBox");
  setMsg("");
});

$("btnAcessarApp").addEventListener("click", ()=> location.href = FRONT_URL);
$("btnPlano6").addEventListener("click", ()=> gerarPix("6m"));
$("btnPlano12").addEventListener("click", ()=> gerarPix("12m"));

$("btnCopiar").addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText($("pixCopia").value);
    $("payMsg").innerHTML = "<span class='ok'>Copiado. Agora pague no app do banco.</span>";
  }catch{
    $("payMsg").innerText = "Não consegui copiar automaticamente. Selecione e copie manualmente.";
  }
});

/* ===== AUTH ===== */
async function entrar() {
  try {
    setMsg("");
    const email = $("email").value.trim();
    const senha = $("senha").value;

    if (!email || !senha) {
      setMsg("Preencha e-mail e senha.");
      return;
    }

    await signInWithEmailAndPassword(auth, email, senha);
    await carregarStatus();
  } catch (e) {
    console.error("Erro login:", e);
    setMsg(e?.message || "E-mail ou senha inválidos.");
  }
}

async function criarConta(){
  try{
    setMsg("");
    const email = $("email").value.trim();
    const senha = $("senha").value;
    if(!email || !senha){ setMsg("Preencha email e senha."); return; }

    await createUserWithEmailAndPassword(auth, email, senha);
    await carregarStatus();
  }catch(e){
    console.error("Erro criarConta:", e);
    setMsg(e?.message || "Erro ao criar conta");
  }
}

async function carregarStatus(){
  const user = auth.currentUser;
  if(!user){ show("loginBox"); return; }

  let data;
  try {
    const resp = await meCall();
    data = resp.data;
  } catch (e) {
    console.error("Erro meCall:", e);
    // Mostra erro na tela e volta para login (não trava)
    show("loginBox");
    setMsg(e?.message || "Falha ao validar sua sessão. Tente novamente.");
    return;
  }

  if(!data.authenticated){
    show("loginBox");
    setMsg("Sessão inválida. Faça login novamente.");
    return;
  }

  const status = data.entitled ? data.plan : "none";
  const expiresIso = data.expiresAt || null;
  const fim = expiresIso ? new Date(expiresIso) : null;

  // ✅ Acesso liberado: premium ou trial ativo
  if (status === "trial" || status === "premium") {
    show("statusBox");

    if (status === "trial") {
      $("statusText").innerText = "Teste grátis ativo";
      $("statusSub").innerText = fim ? ("Válido até: " + fim.toLocaleString()) : "";
    } else {
      $("statusText").innerText = "Acesso Premium ativo";
      $("statusSub").innerText = fim ? ("Válido até: " + fim.toLocaleString()) : "";
    }
    return;
  }

  // ❌ Sem acesso: paywall
  $("qrBox").classList.add("hide");
  $("payMsg").innerText = "";
  $("qrSub").innerText = "";
  show("payBox");
}

/* ===== PIX ===== */
let pollingTimer = null;

async function gerarPix(plan){
  try{
    const user = auth.currentUser;
    if(!user){ show("loginBox"); setMsg("Faça login."); return; }

    $("qrBox").classList.add("hide");
    $("payMsg").innerText = "";
    $("qrSub").innerText = "Gerando cobrança PIX...";

    const resp = await createPixChargeCall({ plan });
    const data = resp.data;

    if(data.alreadyEntitled){
      $("qrSub").innerText = "Seu acesso já está ativo. Abrindo o app...";
      setTimeout(()=>location.href = FRONT_URL, 700);
      return;
    }

    $("qrBox").classList.remove("hide");
    $("qrSub").innerText = `Plano: ${plan} — Valor: R$ ${String(data.price).replace(".", ",")}`;
    $("qrImg").src = "data:image/png;base64," + data.qrcodeImage;
    $("pixCopia").value = data.copiaecola;

    $("payMsg").innerText = "Aguardando pagamento... (deixe esta tela aberta)";

    if(pollingTimer) clearInterval(pollingTimer);
    pollingTimer = setInterval(()=> checarPagamento(data.txid), 5000);

    await checarPagamento(data.txid);

  }catch(e){
    console.error("ERRO createPixCharge:", e);
    const msg = e?.details || e?.message || "Erro ao gerar PIX";
    $("payMsg").innerText = msg;
  }
}

async function checarPagamento(txid){
  try{
    const user = auth.currentUser;
    if(!user) return;

    const resp = await pixStatusCall({ txid });
    const data = resp.data;

    if (data.paid) {
      if(pollingTimer) clearInterval(pollingTimer);
      $("payMsg").innerHTML = "<span class='ok'>Pagamento confirmado. Liberando acesso...</span>";
      setTimeout(()=> location.href = FRONT_URL, 900);
      return;
    }

    $("payMsg").innerText = "Aguardando pagamento... (atualiza automaticamente)";
  }catch{
    // mantém silencioso
  }
}

/* ===== INITIAL ===== */
if(auth.currentUser){
  carregarStatus();
} else {
  show("loginBox");
}
</script>
